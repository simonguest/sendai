const m=e=>new URL(`../pyodide/${e}`,import.meta.url).toString(),d={chess:[m("chess-1.10.0-py3-none-any.whl")]},p=e=>{const l=[];let g;const s=/^\s*import\s+(\w+)(?:\s+as\s+\w+)?(?:\s*,\s*(\w+)(?:\s+as\s+\w+)?)*|^\s*from\s+(\w+)(?:\.\w+)*\s+import/gm,r=new Set;for(;(g=s.exec(e))!==null;){if(g[1]&&(r.add(g[1]),g[2])){const o=g[2].split(",").map(n=>n.trim());for(const n of o)n&&r.add(n)}g[3]&&r.add(g[3])}for(const o of r)if(d[o]){const n=d[o];for(const a of n)l.includes(a)||l.push(a)}return l};var b="data:application/octet-stream;base64,aW1wb3J0IG1hdHBsb3RsaWIKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAppbXBvcnQgaW8KaW1wb3J0IGJhc2U2NAoKbWF0cGxvdGxpYi51c2UoJ0FHRycpCgojIEFkZCBhIHBsdCBfcmVwcl9wbmdfIGZ1bmN0aW9uIC0gdGhpcyB3aWxsIGVtaXQgYSBwbmcgaWYgcGx0IGlzIHJldHVybmVkIGZyb20gYSBjZWxsCmRlZiBfcmVwcl9wbmdfKCk6CiAgICBidWYgPSBpby5CeXRlc0lPKCkKICAgIHBsdC5zYXZlZmlnKGJ1ZiwgZm9ybWF0PSdwbmcnLCBiYm94X2luY2hlcz0ndGlnaHQnKQogICAgYnVmLnNlZWsoMCkKICAgIGltYWdlX2Jhc2U2NCA9IGJhc2U2NC5iNjRlbmNvZGUoYnVmLmdldHZhbHVlKCkpLmRlY29kZSgndXRmLTgnKSAKICAgIHBsdC5jbGYoKQogICAgcGx0LmNsb3NlKCkKICAgIGJ1Zi5jbG9zZSgpCiAgICByZXR1cm4gaW1hZ2VfYmFzZTY0CgpwbHQuX3JlcHJfcG5nXyA9IF9yZXByX3BuZ18KCiMgT3ZlcnJpZGUgdGhlIG9yaWdpbmFsIHNob3cgZnVuY3Rpb24KZGVmIG1hdHBsb3RsaWJfY3VzdG9tX3Nob3coKToKICAgIGltYWdlX2Jhc2U2NCA9IHBsdC5fcmVwcl9wbmdfKCkKICAgIGpzLmltYWdlQmFzZTY0KGltYWdlX2Jhc2U2NCkgIyB0eXBlOmlnbm9yZSAgICAKCnBsdC5zaG93ID0gbWF0cGxvdGxpYl9jdXN0b21fc2hvdwo=";const y=["matplotlib"],u=async(e,l)=>{const s=await(await fetch(new URL(Object.assign({"./matplotlib.py":b})[`./${l}.py`],import.meta.url))).text();await e.runPythonAsync(s)};let t,i=null;const A=typeof SharedArrayBuffer<"u";async function C(e){const g=await(await fetch(e)).text();await t.runPythonAsync(g)}async function Z(){console.log("PyodideWorker: Starting Pyodide initialization...");{const{loadPyodide:e}=await import(new URL("../pyodide/pyodide.mjs",import.meta.url).toString());t=await e()}if(console.log("PyodideWorker: Checking for interrupt buffer"),A){const e=new SharedArrayBuffer(4);i=new Int32Array(e),t.setInterruptBuffer(i),console.log("PyodideWorker: Interrupt buffer created")}else console.warn("PyodideWorker: SharedArrayBuffer is not available, interrupt functionality will be disabled");console.log("PyodideWorker: Creating override for stdout"),t.globals.set("_override_stdout",{write:e=>(self.postMessage({type:"stdout",text:e}),e.length),flush:()=>{}}),console.log("PyodideWorker: Overriding input calls with async equivalent"),C(new URL("data:application/octet-stream;base64,aW1wb3J0IGFzdAoKY2xhc3MgSW5wdXRUcmFuc2Zvcm1lcihhc3QuTm9kZVRyYW5zZm9ybWVyKToKICAgIGRlZiB2aXNpdF9DYWxsKHNlbGYsIG5vZGUpOgogICAgICAgICMgUmVjdXJzaXZlbHkgdHJhbnNmb3JtIGNoaWxkIG5vZGVzIGZpcnN0CiAgICAgICAgc2VsZi5nZW5lcmljX3Zpc2l0KG5vZGUpCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBpZiB0aGlzIGlzIGFuIGlucHV0KCkgY2FsbAogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZS5mdW5jLCBhc3QuTmFtZSkgYW5kIG5vZGUuZnVuYy5pZCA9PSAnaW5wdXQnOgogICAgICAgICAgICAjIENoZWNrIGlmIHdlJ3JlIGFscmVhZHkgaW5zaWRlIGFuIEF3YWl0IG5vZGUKICAgICAgICAgICAgcGFyZW50ID0gZ2V0YXR0cihub2RlLCAncGFyZW50JywgTm9uZSkKICAgICAgICAgICAgd2hpbGUgcGFyZW50OgogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwYXJlbnQsIGFzdC5Bd2FpdCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICAgIHBhcmVudCA9IGdldGF0dHIocGFyZW50LCAncGFyZW50JywgTm9uZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSWYgbm90IGF3YWl0ZWQsIHdyYXAgaW4gQXdhaXQKICAgICAgICAgICAgcmV0dXJuIGFzdC5Bd2FpdCgKICAgICAgICAgICAgICAgIHZhbHVlPW5vZGUsCiAgICAgICAgICAgICAgICBsaW5lbm89bm9kZS5saW5lbm8sCiAgICAgICAgICAgICAgICBjb2xfb2Zmc2V0PW5vZGUuY29sX29mZnNldAogICAgICAgICAgICApCiAgICAgICAgcmV0dXJuIG5vZGUKCmRlZiBfc2V0X3BhcmVudHMobm9kZSwgcGFyZW50PU5vbmUpOgogICAgIyBIZWxwZXIgdG8gc2V0IHBhcmVudCByZWZlcmVuY2VzIGZvciBhbGwgbm9kZXMKICAgIG5vZGUucGFyZW50ID0gcGFyZW50CiAgICBmb3IgY2hpbGQgaW4gYXN0Lml0ZXJfY2hpbGRfbm9kZXMobm9kZSk6CiAgICAgICAgX3NldF9wYXJlbnRzKGNoaWxkLCBub2RlKQoKZGVmIHRyYW5zZm9ybV9jb2RlKGNvZGVfc3RyKToKICAgIHRyeToKICAgICAgICAjIFBhcnNlIHRoZSBjb2RlIGludG8gYW4gQVNUCiAgICAgICAgdHJlZSA9IGFzdC5wYXJzZShjb2RlX3N0cikKICAgICAgICAKICAgICAgICAjIFNldCBwYXJlbnQgcmVmZXJlbmNlcwogICAgICAgIF9zZXRfcGFyZW50cyh0cmVlKQogICAgICAgIAogICAgICAgICMgVHJhbnNmb3JtIHRoZSBBU1QKICAgICAgICB0cmFuc2Zvcm1lciA9IElucHV0VHJhbnNmb3JtZXIoKQogICAgICAgIG5ld190cmVlID0gdHJhbnNmb3JtZXIudmlzaXQodHJlZSkKICAgICAgICAKICAgICAgICAjIEZpeCBhbnkgbWlzc2luZyBsb2NhdGlvbnMKICAgICAgICBhc3QuZml4X21pc3NpbmdfbG9jYXRpb25zKG5ld190cmVlKQogICAgICAgIAogICAgICAgICMgQ29udmVydCBiYWNrIHRvIHNvdXJjZSBjb2RlCiAgICAgICAgdHJhbnNmb3JtZWRfY29kZSA9IGFzdC51bnBhcnNlKG5ld190cmVlKQogICAgICAgIHJldHVybiB0cmFuc2Zvcm1lZF9jb2RlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJUcmFuc2Zvcm1hdGlvbiBlcnJvcjoge3N0cihlKX0iKQogICAgICAgICMgSWYgdHJhbnNmb3JtYXRpb24gZmFpbHMsIHJldHVybiB0aGUgb3JpZ2luYWwgY29kZQogICAgICAgIHJldHVybiBjb2RlX3N0cgo=",import.meta.url)),console.log("PyodideWorkder: Creating override for input"),t.globals.set("_override_input",e=>new Promise(l=>{self.postMessage({type:"input_request",message:e||""});const g=s=>{s.data.type==="input_response"&&(self.removeEventListener("message",g),l(s.data.value))};self.addEventListener("message",g)})),console.log("PyodideWorker: Creating override for js functions"),t.globals.set("js",{imageBase64:e=>{self.postMessage({type:"execute_result",result:{"image/png":[e]}})}}),console.log("PyodideWorker: Initializing Python environment"),C(new URL("data:application/octet-stream;base64,IyB0eXBlOmlnbm9yZQppbXBvcnQgYnVpbHRpbnMKaW1wb3J0IHN5cwoKZGVmIF9vdmVycmlkZV9pbnB1dF93cmFwcGVyKHByb21wdD0nJyk6CiAgICByZXR1cm4gX292ZXJyaWRlX2lucHV0KHByb21wdCkKCnN5cy5zdGRvdXQgPSBfb3ZlcnJpZGVfc3Rkb3V0IApidWlsdGlucy5pbnB1dCA9IF9vdmVycmlkZV9pbnB1dF93cmFwcGVyCg==",import.meta.url))}self.onmessage=async e=>{const{type:l,...g}=e.data;switch(l){case"initialize":try{await Z(),self.postMessage({type:"initialized",interruptBuffer:i?i.buffer:null,hasInterrupt:A})}catch(o){console.error("PyodideWorker: Failed to initialize Pyodide:",o),self.postMessage({type:"fatal",error:String(o)})}break;case"run":const s=g.code,r=g.cellId;try{if(t){console.log("PyodideProvider: Loading packages from imports");const o=await t.loadPackagesFromImports(s);console.log("PyodideProvider: Loading additional packages from code");const n=await t.loadPackage(p(s));console.log("PyodideProvider: Searching for overrides");for(const c of[...o,...n])y.indexOf(c.name)!==-1&&(console.log(`PyodideProvider: Implementing override for ${c.name}`),await u(t,c.name));console.log("PyodideProvider: Transforming code to support async inputs");const a=await t.runPythonAsync(`transform_code(${JSON.stringify(s)})`);console.log(`PyodideProvider: Running cell ${r}`);const I=await t.runPythonAsync(`${a}`);console.log("PyodideProvider: Returning result"),I&&(typeof I=="object"?("_repr_svg_"in I&&self.postMessage({type:"execute_result",result:{"image/svg+xml":I._repr_svg_()}}),"_repr_html_"in I&&self.postMessage({type:"execute_result",result:{"text/html":I._repr_html_()}}),"_repr_png_"in I&&self.postMessage({type:"execute_result",result:{"image/png":I._repr_png_()}}),self.postMessage({type:"execute_result",result:{"text/plain":I.__repr__()}})):self.postMessage({type:"execute_result",result:{"text/plain":I.toString()}})),self.postMessage({type:"execute_completed"})}}catch(o){console.error(o),self.postMessage({type:"error",error:String(o)})}break}};
