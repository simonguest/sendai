var Ca=Object.defineProperty;var or=n=>{throw TypeError(n)};var Ra=(n,e,t)=>e in n?Ca(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var m=(n,e,t)=>Ra(n,typeof e!="symbol"?e+"":e,t),pn=(n,e,t)=>e.has(n)||or("Cannot "+t);var p=(n,e,t)=>(pn(n,e,"read from private field"),t?t.call(n):e.get(n)),A=(n,e,t)=>e.has(n)?or("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),k=(n,e,t,r)=>(pn(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),U=(n,e,t)=>(pn(n,e,"access private method"),t);import{z as Na,a as $a,O as ja}from"./openai-DI9zkULY.js";import{d as Pa}from"./debug-Cg2YkTwG.js";async function Fn(n){try{return[null,await n()]}catch(e){return[e,null]}}class Oe extends Error{constructor(t,r){super(t);m(this,"state");this.state=r}}class Ma extends Oe{}class ir extends Oe{}class ge extends Oe{}class F extends Oe{}class ur extends Oe{constructor(t,r,s){super(t,s);m(this,"error");this.error=r}}class La extends Oe{constructor(t,r,s){super(t,s);m(this,"error");this.error=r}}class cr extends Oe{constructor(t,r,s){super(t,s);m(this,"result");this.result=r}}class lr extends Oe{constructor(t,r,s){super(t,s);m(this,"result");this.result=r}}function ot(n){return typeof n=="object"&&n!==null&&"_def"in n&&typeof n._def=="object"&&n._def!==null&&"typeName"in n._def&&n._def.typeName==="ZodObject"}function Ua(n){return typeof n=="object"&&n!==null&&"input"in n&&typeof n.input=="string"}function qt(n){if(n=n.replace(/\s/g,"_"),n=n.replace(/[^a-zA-Z0-9]/g,"_"),n.length===0)throw new Error("Tool name cannot be empty");return n}function Jn(n,e){const t=r=>JSON.parse(r);if(ot(n)){const r=$a({name:e,parameters:n,function:()=>{}});return{schema:r.parameters,parser:r.$parseRaw}}else if(typeof n=="object"&&n!==null)return{schema:n,parser:t};throw new F("Input type is not a ZodObject or a valid JSON schema")}function dr(n){if(n==="text")return"text";if(ot(n)){const e=Na(n,"output");return{type:e.type,name:e.name,strict:e.strict||!1,schema:e.schema}}return n}function Za(){return zn()}function pr(n){const e=Za();return typeof e<"u"&&(e[n]==="true"||e[n]==="1")}const Hr={get disabled(){return!0}},qr={get dontLogModelData(){return pr("OPENAI_AGENTS_DONT_LOG_MODEL_DATA")},get dontLogToolData(){return pr("OPENAI_AGENTS_DONT_LOG_TOOL_DATA")}},Fa=qr.dontLogModelData,Ja=qr.dontLogToolData;function Gn(n="openai-agents"){return{namespace:n,debug:Pa(n),error:console.error,warn:console.warn,dontLogModelData:Fa,dontLogToolData:Ja}}const I=Gn("openai-agents:core");function it(n){if(n==null)return String(n);if(typeof n=="string")return n;if(typeof n=="object")try{return JSON.stringify(n)}catch{return"[object with circular references]"}return String(n)}function Ga(n,e){return`An error occurred while running the tool. Please try again. Error: ${e instanceof Error?e.toString():String(e)}`}function wn(n){const e=n.name?qt(n.name):qt(n.execute.name),t=typeof n.errorFunction>"u"?Ga:n.errorFunction;if(!e)throw new Error("Tool name cannot be empty. Either name your function or provide a name in the options.");const r=n.strict??!0;if(!r&&ot(n.parameters))throw new F("Strict mode is required for Zod parameters");const{parser:s,schema:a}=Jn(n.parameters,e);async function o(l,d){const[y,w]=await Fn(()=>s(d));if(y!==null)throw I.dontLogToolData?I.debug(`Invalid JSON input for tool ${e}`):I.debug(`Invalid JSON input for tool ${e}: ${d}`),new ge("Invalid JSON input for tool");I.dontLogToolData?I.debug(`Invoking tool ${e}`):I.debug(`Invoking tool ${e} with input ${d}`);const E=await n.execute(w,l),b=it(E);return I.dontLogToolData?I.debug(`Tool ${e} completed`):I.debug(`Tool ${e} returned: ${b}`),E}async function i(l,d){return o(l,d).catch(y=>{if(t){const w=St();return w==null||w.setError({message:"Error running tool (non-fatal)",data:{tool_name:e,error:y.toString()}}),t(l,y)}throw y})}const c=typeof n.needsApproval=="function"?n.needsApproval:async()=>typeof n.needsApproval=="boolean"?n.needsApproval:!1;return{type:"function",name:e,description:n.description,parameters:a,strict:r,invoke:i,needsApproval:c}}var j;(function(n){n.assertEqual=s=>{};function e(s){}n.assertIs=e;function t(s){throw new Error}n.assertNever=t,n.arrayToEnum=s=>{const a={};for(const o of s)a[o]=o;return a},n.getValidEnumValues=s=>{const a=n.objectKeys(s).filter(i=>typeof s[s[i]]!="number"),o={};for(const i of a)o[i]=s[i];return n.objectValues(o)},n.objectValues=s=>n.objectKeys(s).map(function(a){return s[a]}),n.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const a=[];for(const o in s)Object.prototype.hasOwnProperty.call(s,o)&&a.push(o);return a},n.find=(s,a)=>{for(const o of s)if(a(o))return o},n.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(o=>typeof o=="string"?`'${o}'`:o).join(a)}n.joinValues=r,n.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(j||(j={}));var fr;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(fr||(fr={}));const x=j.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Se=n=>{switch(typeof n){case"undefined":return x.undefined;case"string":return x.string;case"number":return Number.isNaN(n)?x.nan:x.number;case"boolean":return x.boolean;case"function":return x.function;case"bigint":return x.bigint;case"symbol":return x.symbol;case"object":return Array.isArray(n)?x.array:n===null?x.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?x.promise:typeof Map<"u"&&n instanceof Map?x.map:typeof Set<"u"&&n instanceof Set?x.set:typeof Date<"u"&&n instanceof Date?x.date:x.object;default:return x.unknown}},_=j.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class ve extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},r={_errors:[]},s=a=>{for(const o of a.issues)if(o.code==="invalid_union")o.unionErrors.map(s);else if(o.code==="invalid_return_type")s(o.returnTypeError);else if(o.code==="invalid_arguments")s(o.argumentsError);else if(o.path.length===0)r._errors.push(t(o));else{let i=r,c=0;for(;c<o.path.length;){const l=o.path[c];c===o.path.length-1?(i[l]=i[l]||{_errors:[]},i[l]._errors.push(t(o))):i[l]=i[l]||{_errors:[]},i=i[l],c++}}};return s(this),r}static assert(e){if(!(e instanceof ve))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,j.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}ve.create=n=>new ve(n);const xn=(n,e)=>{let t;switch(n.code){case _.invalid_type:n.received===x.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case _.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,j.jsonStringifyReplacer)}`;break;case _.unrecognized_keys:t=`Unrecognized key(s) in object: ${j.joinValues(n.keys,", ")}`;break;case _.invalid_union:t="Invalid input";break;case _.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${j.joinValues(n.options)}`;break;case _.invalid_enum_value:t=`Invalid enum value. Expected ${j.joinValues(n.options)}, received '${n.received}'`;break;case _.invalid_arguments:t="Invalid function arguments";break;case _.invalid_return_type:t="Invalid function return type";break;case _.invalid_date:t="Invalid date";break;case _.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:j.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case _.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case _.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case _.custom:t="Invalid input";break;case _.invalid_intersection_types:t="Intersection results could not be merged";break;case _.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case _.not_finite:t="Number must be finite";break;default:t=e.defaultError,j.assertNever(n)}return{message:t}};let Ba=xn;function Va(){return Ba}const za=n=>{const{data:e,path:t,errorMaps:r,issueData:s}=n,a=[...t,...s.path||[]],o={...s,path:a};if(s.message!==void 0)return{...s,path:a,message:s.message};let i="";const c=r.filter(l=>!!l).slice().reverse();for(const l of c)i=l(o,{data:e,defaultError:i}).message;return{...s,path:a,message:i}};function g(n,e){const t=Va(),r=za({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===xn?void 0:xn].filter(s=>!!s)});n.common.issues.push(r)}class Y{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const s of t){if(s.status==="aborted")return D;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const s of t){const a=await s.key,o=await s.value;r.push({key:a,value:o})}return Y.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const s of t){const{key:a,value:o}=s;if(a.status==="aborted"||o.status==="aborted")return D;a.status==="dirty"&&e.dirty(),o.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof o.value<"u"||s.alwaysSet)&&(r[a.value]=o.value)}return{status:e.value,value:r}}}const D=Object.freeze({status:"aborted"}),_t=n=>({status:"dirty",value:n}),se=n=>({status:"valid",value:n}),hr=n=>n.status==="aborted",mr=n=>n.status==="dirty",ut=n=>n.status==="valid",Wt=n=>typeof Promise<"u"&&n instanceof Promise;var S;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(S||(S={}));class de{constructor(e,t,r,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const _r=(n,e)=>{if(ut(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new ve(n.common.issues);return this._error=t,this._error}}};function C(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:s}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(o,i)=>{const{message:c}=n;return o.code==="invalid_enum_value"?{message:c??i.defaultError}:typeof i.data>"u"?{message:c??r??i.defaultError}:o.code!=="invalid_type"?{message:i.defaultError}:{message:c??t??i.defaultError}},description:s}}class R{get description(){return this._def.description}_getType(e){return Se(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Se(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Y,ctx:{common:e.parent.common,data:e.data,parsedType:Se(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Wt(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){const r={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Se(e)},s=this._parseSync({data:e,path:r.path,parent:r});return _r(r,s)}"~validate"(e){var r,s;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Se(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:t});return ut(a)?{value:a.value}:{issues:t.common.issues}}catch(a){(s=(r=a==null?void 0:a.message)==null?void 0:r.toLowerCase())!=null&&s.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>ut(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Se(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(Wt(s)?s:Promise.resolve(s));return _r(r,a)}refine(e,t){const r=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,a)=>{const o=e(s),i=()=>a.addIssue({code:_.custom,...r(s)});return typeof Promise<"u"&&o instanceof Promise?o.then(c=>c?!0:(i(),!1)):o?!0:(i(),!1)})}refinement(e,t){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof t=="function"?t(r,s):t),!1))}_refinement(e){return new Ze({schema:this,typeName:O.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return ye.create(this,this._def)}nullable(){return Fe.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return le.create(this)}promise(){return nn.create(this,this._def)}or(e){return Yt.create([this,e],this._def)}and(e){return Xt.create(this,e,this._def)}transform(e){return new Ze({...C(this._def),schema:this,typeName:O.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new rn({...C(this._def),innerType:this,defaultValue:t,typeName:O.ZodDefault})}brand(){return new Xr({typeName:O.ZodBranded,type:this,...C(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new an({...C(this._def),innerType:this,catchValue:t,typeName:O.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Vn.create(this,e)}readonly(){return sn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Ha=/^c[^\s-]{8,}$/i,qa=/^[0-9a-z]+$/,Wa=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Ka=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ya=/^[a-z0-9_-]{21}$/i,Xa=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Qa=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,es=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,ts="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let fn;const ns=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,rs=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,as=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,ss=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,os=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,is=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Wr="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",us=new RegExp(`^${Wr}$`);function Kr(n){let e="[0-5]\\d";n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`);const t=n.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function cs(n){return new RegExp(`^${Kr(n)}$`)}function ls(n){let e=`${Wr}T${Kr(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function ds(n,e){return!!((e==="v4"||!e)&&ns.test(n)||(e==="v6"||!e)&&as.test(n))}function ps(n,e){if(!Xa.test(n))return!1;try{const[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),s=JSON.parse(atob(r));return!(typeof s!="object"||s===null||"typ"in s&&(s==null?void 0:s.typ)!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function fs(n,e){return!!((e==="v4"||!e)&&rs.test(n)||(e==="v6"||!e)&&ss.test(n))}class _e extends R{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==x.string){const a=this._getOrReturnCtx(e);return g(a,{code:_.invalid_type,expected:x.string,received:a.parsedType}),D}const r=new Y;let s;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),g(s,{code:_.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),g(s,{code:_.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){const o=e.data.length>a.value,i=e.data.length<a.value;(o||i)&&(s=this._getOrReturnCtx(e,s),o?g(s,{code:_.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):i&&g(s,{code:_.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")es.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"email",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")fn||(fn=new RegExp(ts,"u")),fn.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"emoji",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")Ka.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"uuid",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="nanoid")Ya.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"nanoid",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")Ha.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"cuid",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")qa.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"cuid2",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")Wa.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"ulid",code:_.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),g(s,{validation:"url",code:_.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"regex",code:_.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),g(s,{code:_.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),g(s,{code:_.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),g(s,{code:_.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?ls(a).test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{code:_.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="date"?us.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{code:_.invalid_string,validation:"date",message:a.message}),r.dirty()):a.kind==="time"?cs(a).test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{code:_.invalid_string,validation:"time",message:a.message}),r.dirty()):a.kind==="duration"?Qa.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"duration",code:_.invalid_string,message:a.message}),r.dirty()):a.kind==="ip"?ds(e.data,a.version)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"ip",code:_.invalid_string,message:a.message}),r.dirty()):a.kind==="jwt"?ps(e.data,a.alg)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"jwt",code:_.invalid_string,message:a.message}),r.dirty()):a.kind==="cidr"?fs(e.data,a.version)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"cidr",code:_.invalid_string,message:a.message}),r.dirty()):a.kind==="base64"?os.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"base64",code:_.invalid_string,message:a.message}),r.dirty()):a.kind==="base64url"?is.test(e.data)||(s=this._getOrReturnCtx(e,s),g(s,{validation:"base64url",code:_.invalid_string,message:a.message}),r.dirty()):j.assertNever(a);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(s=>e.test(s),{validation:t,code:_.invalid_string,...S.errToObj(r)})}_addCheck(e){return new _e({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...S.errToObj(e)})}url(e){return this._addCheck({kind:"url",...S.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...S.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...S.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...S.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...S.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...S.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...S.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...S.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...S.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...S.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...S.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...S.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...S.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...S.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...S.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...S.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...S.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...S.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...S.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...S.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...S.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...S.errToObj(t)})}nonempty(e){return this.min(1,S.errToObj(e))}trim(){return new _e({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new _e({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new _e({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}_e.create=n=>new _e({checks:[],typeName:O.ZodString,coerce:(n==null?void 0:n.coerce)??!1,...C(n)});function hs(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=t>r?t:r,a=Number.parseInt(n.toFixed(s).replace(".","")),o=Number.parseInt(e.toFixed(s).replace(".",""));return a%o/10**s}class ct extends R{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==x.number){const a=this._getOrReturnCtx(e);return g(a,{code:_.invalid_type,expected:x.number,received:a.parsedType}),D}let r;const s=new Y;for(const a of this._def.checks)a.kind==="int"?j.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),g(r,{code:_.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),g(r,{code:_.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),g(r,{code:_.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?hs(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),g(r,{code:_.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),g(r,{code:_.not_finite,message:a.message}),s.dirty()):j.assertNever(a);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,S.toString(t))}gt(e,t){return this.setLimit("min",e,!1,S.toString(t))}lte(e,t){return this.setLimit("max",e,!0,S.toString(t))}lt(e,t){return this.setLimit("max",e,!1,S.toString(t))}setLimit(e,t,r,s){return new ct({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:S.toString(s)}]})}_addCheck(e){return new ct({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:S.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:S.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:S.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:S.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:S.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:S.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:S.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:S.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:S.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&j.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ct.create=n=>new ct({checks:[],typeName:O.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...C(n)});class vt extends R{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==x.bigint)return this._getInvalidInput(e);let r;const s=new Y;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),g(r,{code:_.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),g(r,{code:_.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),g(r,{code:_.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):j.assertNever(a);return{status:s.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return g(t,{code:_.invalid_type,expected:x.bigint,received:t.parsedType}),D}gte(e,t){return this.setLimit("min",e,!0,S.toString(t))}gt(e,t){return this.setLimit("min",e,!1,S.toString(t))}lte(e,t){return this.setLimit("max",e,!0,S.toString(t))}lt(e,t){return this.setLimit("max",e,!1,S.toString(t))}setLimit(e,t,r,s){return new vt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:S.toString(s)}]})}_addCheck(e){return new vt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:S.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:S.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:S.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:S.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:S.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}vt.create=n=>new vt({checks:[],typeName:O.ZodBigInt,coerce:(n==null?void 0:n.coerce)??!1,...C(n)});class Sn extends R{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==x.boolean){const r=this._getOrReturnCtx(e);return g(r,{code:_.invalid_type,expected:x.boolean,received:r.parsedType}),D}return se(e.data)}}Sn.create=n=>new Sn({typeName:O.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...C(n)});class Kt extends R{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==x.date){const a=this._getOrReturnCtx(e);return g(a,{code:_.invalid_type,expected:x.date,received:a.parsedType}),D}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return g(a,{code:_.invalid_date}),D}const r=new Y;let s;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),g(s,{code:_.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),g(s,{code:_.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):j.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Kt({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:S.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:S.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Kt.create=n=>new Kt({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:O.ZodDate,...C(n)});class gr extends R{_parse(e){if(this._getType(e)!==x.symbol){const r=this._getOrReturnCtx(e);return g(r,{code:_.invalid_type,expected:x.symbol,received:r.parsedType}),D}return se(e.data)}}gr.create=n=>new gr({typeName:O.ZodSymbol,...C(n)});class Tn extends R{_parse(e){if(this._getType(e)!==x.undefined){const r=this._getOrReturnCtx(e);return g(r,{code:_.invalid_type,expected:x.undefined,received:r.parsedType}),D}return se(e.data)}}Tn.create=n=>new Tn({typeName:O.ZodUndefined,...C(n)});class bn extends R{_parse(e){if(this._getType(e)!==x.null){const r=this._getOrReturnCtx(e);return g(r,{code:_.invalid_type,expected:x.null,received:r.parsedType}),D}return se(e.data)}}bn.create=n=>new bn({typeName:O.ZodNull,...C(n)});class kn extends R{constructor(){super(...arguments),this._any=!0}_parse(e){return se(e.data)}}kn.create=n=>new kn({typeName:O.ZodAny,...C(n)});class yr extends R{constructor(){super(...arguments),this._unknown=!0}_parse(e){return se(e.data)}}yr.create=n=>new yr({typeName:O.ZodUnknown,...C(n)});class De extends R{_parse(e){const t=this._getOrReturnCtx(e);return g(t,{code:_.invalid_type,expected:x.never,received:t.parsedType}),D}}De.create=n=>new De({typeName:O.ZodNever,...C(n)});class vr extends R{_parse(e){if(this._getType(e)!==x.undefined){const r=this._getOrReturnCtx(e);return g(r,{code:_.invalid_type,expected:x.void,received:r.parsedType}),D}return se(e.data)}}vr.create=n=>new vr({typeName:O.ZodVoid,...C(n)});class le extends R{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),s=this._def;if(t.parsedType!==x.array)return g(t,{code:_.invalid_type,expected:x.array,received:t.parsedType}),D;if(s.exactLength!==null){const o=t.data.length>s.exactLength.value,i=t.data.length<s.exactLength.value;(o||i)&&(g(t,{code:o?_.too_big:_.too_small,minimum:i?s.exactLength.value:void 0,maximum:o?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(g(t,{code:_.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(g(t,{code:_.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((o,i)=>s.type._parseAsync(new de(t,o,t.path,i)))).then(o=>Y.mergeArray(r,o));const a=[...t.data].map((o,i)=>s.type._parseSync(new de(t,o,t.path,i)));return Y.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new le({...this._def,minLength:{value:e,message:S.toString(t)}})}max(e,t){return new le({...this._def,maxLength:{value:e,message:S.toString(t)}})}length(e,t){return new le({...this._def,exactLength:{value:e,message:S.toString(t)}})}nonempty(e){return this.min(1,e)}}le.create=(n,e)=>new le({type:n,minLength:null,maxLength:null,exactLength:null,typeName:O.ZodArray,...C(e)});function ze(n){if(n instanceof G){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=ye.create(ze(r))}return new G({...n._def,shape:()=>e})}else return n instanceof le?new le({...n._def,type:ze(n.element)}):n instanceof ye?ye.create(ze(n.unwrap())):n instanceof Fe?Fe.create(ze(n.unwrap())):n instanceof Le?Le.create(n.items.map(e=>ze(e))):n}class G extends R{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=j.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==x.object){const l=this._getOrReturnCtx(e);return g(l,{code:_.invalid_type,expected:x.object,received:l.parsedType}),D}const{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:o}=this._getCached(),i=[];if(!(this._def.catchall instanceof De&&this._def.unknownKeys==="strip"))for(const l in s.data)o.includes(l)||i.push(l);const c=[];for(const l of o){const d=a[l],y=s.data[l];c.push({key:{status:"valid",value:l},value:d._parse(new de(s,y,s.path,l)),alwaysSet:l in s.data})}if(this._def.catchall instanceof De){const l=this._def.unknownKeys;if(l==="passthrough")for(const d of i)c.push({key:{status:"valid",value:d},value:{status:"valid",value:s.data[d]}});else if(l==="strict")i.length>0&&(g(s,{code:_.unrecognized_keys,keys:i}),r.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const d of i){const y=s.data[d];c.push({key:{status:"valid",value:d},value:l._parse(new de(s,y,s.path,d)),alwaysSet:d in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const l=[];for(const d of c){const y=await d.key,w=await d.value;l.push({key:y,value:w,alwaysSet:d.alwaysSet})}return l}).then(l=>Y.mergeObjectSync(r,l)):Y.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return S.errToObj,new G({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,o;const s=((o=(a=this._def).errorMap)==null?void 0:o.call(a,t,r).message)??r.defaultError;return t.code==="unrecognized_keys"?{message:S.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new G({...this._def,unknownKeys:"strip"})}passthrough(){return new G({...this._def,unknownKeys:"passthrough"})}extend(e){return new G({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new G({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:O.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new G({...this._def,catchall:e})}pick(e){const t={};for(const r of j.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new G({...this._def,shape:()=>t})}omit(e){const t={};for(const r of j.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new G({...this._def,shape:()=>t})}deepPartial(){return ze(this)}partial(e){const t={};for(const r of j.objectKeys(this.shape)){const s=this.shape[r];e&&!e[r]?t[r]=s:t[r]=s.optional()}return new G({...this._def,shape:()=>t})}required(e){const t={};for(const r of j.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof ye;)a=a._def.innerType;t[r]=a}return new G({...this._def,shape:()=>t})}keyof(){return Yr(j.objectKeys(this.shape))}}G.create=(n,e)=>new G({shape:()=>n,unknownKeys:"strip",catchall:De.create(),typeName:O.ZodObject,...C(e)});G.strictCreate=(n,e)=>new G({shape:()=>n,unknownKeys:"strict",catchall:De.create(),typeName:O.ZodObject,...C(e)});G.lazycreate=(n,e)=>new G({shape:n,unknownKeys:"strip",catchall:De.create(),typeName:O.ZodObject,...C(e)});class Yt extends R{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function s(a){for(const i of a)if(i.result.status==="valid")return i.result;for(const i of a)if(i.result.status==="dirty")return t.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(i=>new ve(i.ctx.common.issues));return g(t,{code:_.invalid_union,unionErrors:o}),D}if(t.common.async)return Promise.all(r.map(async a=>{const o={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:o}),ctx:o}})).then(s);{let a;const o=[];for(const c of r){const l={...t,common:{...t.common,issues:[]},parent:null},d=c._parseSync({data:t.data,path:t.path,parent:l});if(d.status==="valid")return d;d.status==="dirty"&&!a&&(a={result:d,ctx:l}),l.common.issues.length&&o.push(l.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const i=o.map(c=>new ve(c));return g(t,{code:_.invalid_union,unionErrors:i}),D}}get options(){return this._def.options}}Yt.create=(n,e)=>new Yt({options:n,typeName:O.ZodUnion,...C(e)});const fe=n=>n instanceof en?fe(n.schema):n instanceof Ze?fe(n.innerType()):n instanceof tn?[n.value]:n instanceof Ue?n.options:n instanceof An?j.objectValues(n.enum):n instanceof rn?fe(n._def.innerType):n instanceof Tn?[void 0]:n instanceof bn?[null]:n instanceof ye?[void 0,...fe(n.unwrap())]:n instanceof Fe?[null,...fe(n.unwrap())]:n instanceof Xr||n instanceof sn?fe(n.unwrap()):n instanceof an?fe(n._def.innerType):[];class Bn extends R{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==x.object)return g(t,{code:_.invalid_type,expected:x.object,received:t.parsedType}),D;const r=this.discriminator,s=t.data[r],a=this.optionsMap.get(s);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(g(t,{code:_.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),D)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const s=new Map;for(const a of t){const o=fe(a.shape[e]);if(!o.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const i of o){if(s.has(i))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(i)}`);s.set(i,a)}}return new Bn({typeName:O.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...C(r)})}}function In(n,e){const t=Se(n),r=Se(e);if(n===e)return{valid:!0,data:n};if(t===x.object&&r===x.object){const s=j.objectKeys(e),a=j.objectKeys(n).filter(i=>s.indexOf(i)!==-1),o={...n,...e};for(const i of a){const c=In(n[i],e[i]);if(!c.valid)return{valid:!1};o[i]=c.data}return{valid:!0,data:o}}else if(t===x.array&&r===x.array){if(n.length!==e.length)return{valid:!1};const s=[];for(let a=0;a<n.length;a++){const o=n[a],i=e[a],c=In(o,i);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return t===x.date&&r===x.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class Xt extends R{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=(a,o)=>{if(hr(a)||hr(o))return D;const i=In(a.value,o.value);return i.valid?((mr(a)||mr(o))&&t.dirty(),{status:t.value,value:i.data}):(g(r,{code:_.invalid_intersection_types}),D)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,o])=>s(a,o)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}Xt.create=(n,e,t)=>new Xt({left:n,right:e,typeName:O.ZodIntersection,...C(t)});class Le extends R{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==x.array)return g(r,{code:_.invalid_type,expected:x.array,received:r.parsedType}),D;if(r.data.length<this._def.items.length)return g(r,{code:_.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),D;!this._def.rest&&r.data.length>this._def.items.length&&(g(r,{code:_.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...r.data].map((o,i)=>{const c=this._def.items[i]||this._def.rest;return c?c._parse(new de(r,o,r.path,i)):null}).filter(o=>!!o);return r.common.async?Promise.all(a).then(o=>Y.mergeArray(t,o)):Y.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new Le({...this._def,rest:e})}}Le.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Le({items:n,typeName:O.ZodTuple,rest:null,...C(e)})};class Qt extends R{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==x.object)return g(r,{code:_.invalid_type,expected:x.object,received:r.parsedType}),D;const s=[],a=this._def.keyType,o=this._def.valueType;for(const i in r.data)s.push({key:a._parse(new de(r,i,r.path,i)),value:o._parse(new de(r,r.data[i],r.path,i)),alwaysSet:i in r.data});return r.common.async?Y.mergeObjectAsync(t,s):Y.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof R?new Qt({keyType:e,valueType:t,typeName:O.ZodRecord,...C(r)}):new Qt({keyType:_e.create(),valueType:e,typeName:O.ZodRecord,...C(t)})}}class wr extends R{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==x.map)return g(r,{code:_.invalid_type,expected:x.map,received:r.parsedType}),D;const s=this._def.keyType,a=this._def.valueType,o=[...r.data.entries()].map(([i,c],l)=>({key:s._parse(new de(r,i,r.path,[l,"key"])),value:a._parse(new de(r,c,r.path,[l,"value"]))}));if(r.common.async){const i=new Map;return Promise.resolve().then(async()=>{for(const c of o){const l=await c.key,d=await c.value;if(l.status==="aborted"||d.status==="aborted")return D;(l.status==="dirty"||d.status==="dirty")&&t.dirty(),i.set(l.value,d.value)}return{status:t.value,value:i}})}else{const i=new Map;for(const c of o){const l=c.key,d=c.value;if(l.status==="aborted"||d.status==="aborted")return D;(l.status==="dirty"||d.status==="dirty")&&t.dirty(),i.set(l.value,d.value)}return{status:t.value,value:i}}}}wr.create=(n,e,t)=>new wr({valueType:e,keyType:n,typeName:O.ZodMap,...C(t)});class wt extends R{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==x.set)return g(r,{code:_.invalid_type,expected:x.set,received:r.parsedType}),D;const s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(g(r,{code:_.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(g(r,{code:_.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const a=this._def.valueType;function o(c){const l=new Set;for(const d of c){if(d.status==="aborted")return D;d.status==="dirty"&&t.dirty(),l.add(d.value)}return{status:t.value,value:l}}const i=[...r.data.values()].map((c,l)=>a._parse(new de(r,c,r.path,l)));return r.common.async?Promise.all(i).then(c=>o(c)):o(i)}min(e,t){return new wt({...this._def,minSize:{value:e,message:S.toString(t)}})}max(e,t){return new wt({...this._def,maxSize:{value:e,message:S.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}wt.create=(n,e)=>new wt({valueType:n,minSize:null,maxSize:null,typeName:O.ZodSet,...C(e)});class en extends R{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}en.create=(n,e)=>new en({getter:n,typeName:O.ZodLazy,...C(e)});class tn extends R{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return g(t,{received:t.data,code:_.invalid_literal,expected:this._def.value}),D}return{status:"valid",value:e.data}}get value(){return this._def.value}}tn.create=(n,e)=>new tn({value:n,typeName:O.ZodLiteral,...C(e)});function Yr(n,e){return new Ue({values:n,typeName:O.ZodEnum,...C(e)})}class Ue extends R{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return g(t,{expected:j.joinValues(r),received:t.parsedType,code:_.invalid_type}),D}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return g(t,{received:t.data,code:_.invalid_enum_value,options:r}),D}return se(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Ue.create(e,{...this._def,...t})}exclude(e,t=this._def){return Ue.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}Ue.create=Yr;class An extends R{_parse(e){const t=j.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==x.string&&r.parsedType!==x.number){const s=j.objectValues(t);return g(r,{expected:j.joinValues(s),received:r.parsedType,code:_.invalid_type}),D}if(this._cache||(this._cache=new Set(j.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const s=j.objectValues(t);return g(r,{received:r.data,code:_.invalid_enum_value,options:s}),D}return se(e.data)}get enum(){return this._def.values}}An.create=(n,e)=>new An({values:n,typeName:O.ZodNativeEnum,...C(e)});class nn extends R{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==x.promise&&t.common.async===!1)return g(t,{code:_.invalid_type,expected:x.promise,received:t.parsedType}),D;const r=t.parsedType===x.promise?t.data:Promise.resolve(t.data);return se(r.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}}nn.create=(n,e)=>new nn({type:n,typeName:O.ZodPromise,...C(e)});class Ze extends R{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===O.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:o=>{g(r,o),o.fatal?t.abort():t.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){const o=s.transform(r.data,a);if(r.common.async)return Promise.resolve(o).then(async i=>{if(t.value==="aborted")return D;const c=await this._def.schema._parseAsync({data:i,path:r.path,parent:r});return c.status==="aborted"?D:c.status==="dirty"||t.value==="dirty"?_t(c.value):c});{if(t.value==="aborted")return D;const i=this._def.schema._parseSync({data:o,path:r.path,parent:r});return i.status==="aborted"?D:i.status==="dirty"||t.value==="dirty"?_t(i.value):i}}if(s.type==="refinement"){const o=i=>{const c=s.refinement(i,a);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return i};if(r.common.async===!1){const i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?D:(i.status==="dirty"&&t.dirty(),o(i.value),{status:t.value,value:i.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>i.status==="aborted"?D:(i.status==="dirty"&&t.dirty(),o(i.value).then(()=>({status:t.value,value:i.value}))))}if(s.type==="transform")if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!ut(o))return D;const i=s.transform(o.value,a);if(i instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:i}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>ut(o)?Promise.resolve(s.transform(o.value,a)).then(i=>({status:t.value,value:i})):D);j.assertNever(s)}}Ze.create=(n,e,t)=>new Ze({schema:n,typeName:O.ZodEffects,effect:e,...C(t)});Ze.createWithPreprocess=(n,e,t)=>new Ze({schema:e,effect:{type:"preprocess",transform:n},typeName:O.ZodEffects,...C(t)});class ye extends R{_parse(e){return this._getType(e)===x.undefined?se(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ye.create=(n,e)=>new ye({innerType:n,typeName:O.ZodOptional,...C(e)});class Fe extends R{_parse(e){return this._getType(e)===x.null?se(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Fe.create=(n,e)=>new Fe({innerType:n,typeName:O.ZodNullable,...C(e)});class rn extends R{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===x.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}rn.create=(n,e)=>new rn({innerType:n,typeName:O.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...C(e)});class an extends R{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Wt(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new ve(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new ve(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}an.create=(n,e)=>new an({innerType:n,typeName:O.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...C(e)});class xr extends R{_parse(e){if(this._getType(e)!==x.nan){const r=this._getOrReturnCtx(e);return g(r,{code:_.invalid_type,expected:x.nan,received:r.parsedType}),D}return{status:"valid",value:e.data}}}xr.create=n=>new xr({typeName:O.ZodNaN,...C(n)});class Xr extends R{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Vn extends R{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?D:a.status==="dirty"?(t.dirty(),_t(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{const s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?D:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,t){return new Vn({in:e,out:t,typeName:O.ZodPipeline})}}class sn extends R{_parse(e){const t=this._def.innerType._parse(e),r=s=>(ut(s)&&(s.value=Object.freeze(s.value)),s);return Wt(t)?t.then(s=>r(s)):r(t)}unwrap(){return this._def.innerType}}sn.create=(n,e)=>new sn({innerType:n,typeName:O.ZodReadonly,...C(e)});var O;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(O||(O={}));const u=_e.create,T=ct.create,yt=Sn.create,$=kn.create;De.create;const P=le.create,h=G.create,Qr=Yt.create,re=Bn.create;Xt.create;Le.create;const V=Qt.create,ms=en.create,f=tn.create,J=Ue.create;nn.create;ye.create;Fe.create;h({name:u(),description:u().optional(),inputSchema:h({type:f("object"),properties:V(u(),$()),required:P(u()),additionalProperties:yt()})});async function _s(n,e=!1){const t=[],r=new Set;for(const s of n){const a=await gs(s,e),i=[...new Set(a.map(c=>c.name))].filter(c=>r.has(c));if(i.length>0)throw new F(`Duplicate tool names found across MCP servers: ${i.join(", ")}`);for(const c of a)r.add(c.name),t.push(c)}return t}const hn={};async function gs(n,e){return n.cacheToolsList&&hn[n.name]?hn[n.name].map(t=>Sr(t,n,e)):Gs(async t=>{const r=await n.listTools();t.spanData.result=r.map(a=>a.name);const s=r.map(a=>Sr(a,n,e));return n.cacheToolsList&&(hn[n.name]=r),s},{data:{server:n.name}})}async function ys(n,e=!1){return _s(n,e)}function Sr(n,e,t){var o,i,c,l;async function r(d,y){let w={};typeof d=="string"&&d?w=JSON.parse(d):typeof d=="object"&&d!=null&&(w=d);const E=St();E&&(E.spanData.mcp_data={server:e.name});const b=await e.callTool(n.name,w);return b.length===1?b[0]:b}const s={type:((o=n.inputSchema)==null?void 0:o.type)??"object",properties:((i=n.inputSchema)==null?void 0:i.properties)??{},required:((c=n.inputSchema)==null?void 0:c.required)??[],additionalProperties:((l=n.inputSchema)==null?void 0:l.additionalProperties)??!1};if(t||s.additionalProperties===!0)try{const d=vs(s);return wn({name:n.name,description:n.description||"",parameters:d,strict:!0,execute:r})}catch(d){I.warn(`Error converting MCP schema to strict mode: ${d}`)}const a={...s,additionalProperties:!0};return wn({name:n.name,description:n.description||"",parameters:a,strict:!1,execute:r})}function vs(n){const e={...n,additionalProperties:!1};return e.required||(e.required=[]),e}function zn(){return{}}var Ye;class ea{constructor(){A(this,Ye,new EventTarget)}on(e,t){return p(this,Ye).addEventListener(e,r=>t(...r.detail??[])),this}off(e,t){return p(this,Ye).removeEventListener(e,r=>t(...r.detail??[])),this}emit(e,...t){const r=new CustomEvent(e,{detail:t});return p(this,Ye).dispatchEvent(r)}once(e,t){const r=(...s)=>{this.off(e,r),t(...s)};return this.on(e,r),this}}Ye=new WeakMap;const ta=crypto.randomUUID.bind(crypto),ws=class{constructor(){}pipeTo(e,t){}pipeThrough(e,t){}},xs=globalThis.ReadableStream,Ss=globalThis.TransformStream;class Ts{constructor(){m(this,"context",null)}run(e,t){return this.context=e,t()}getStore(){return this.context}enterWith(e){this.context=e}}class bs{constructor(){}setTimeout(e,t){const r=setTimeout(e,t);return r.ref=typeof r.ref=="function"?r.ref:()=>r,r.unref=typeof r.unref=="function"?r.unref:()=>r,r.hasRef=typeof r.hasRef=="function"?r.hasRef:()=>!0,r.refresh=typeof r.refresh=="function"?r.refresh:()=>r,r}clearTimeout(e){window.clearTimeout(e)}}const ks=new bs;let Tr;function pe(){return Tr??(Tr=new Ts),Tr}function xt(){const n=pe().getStore();return n!=null&&n.trace?n.trace:null}function St(){const n=pe().getStore();return n!=null&&n.span?n.span:null}function na(n){return async()=>{const e=xt();if(!e)throw new Error("No trace found");await e.start();const t=await n(e);return await e.end(),t}}async function Is(n,e,t={}){const r=typeof n=="string"?ae().createTrace({...t,name:n}):n;return pe().run({trace:r},na(e))}async function As(n,e={}){if(xt())return await n();const r=ae().createTrace(e);return pe().run({trace:r},na(n))}function We(n){const e=pe().getStore();if(!e)throw new Error("No existing trace found");e.span&&(e.span.previousSpan=e.previousSpan,e.previousSpan=e.span),e.span=n,pe().enterWith(e)}function Ce(){var e;const n=pe().getStore();n&&(n.span=n.previousSpan,n.previousSpan=(e=n.previousSpan)==null?void 0:e.previousSpan,pe().enterWith(n))}function Ke(n){const e=St();e&&e.setError(n)}function Ds(n){var e,t,r;return{trace:(e=n.trace)==null?void 0:e.clone(),span:(t=n.span)==null?void 0:t.clone(),previousSpan:(r=n.previousSpan)==null?void 0:r.clone()}}function Dn(n){const e=pe().getStore();if(!e)throw new Error("No existing trace found");const t=Ds(e);return pe().run(t,n)}class Os{async export(e){if(Hr.disabled){I.debug("Tracing is disabled. Skipping export");return}for(const t of e)t.type==="trace"?console.log(`[Exporter] Export trace traceId=${t.traceId} name=${t.name}`):console.log(`[Exporter] Export span: ${JSON.stringify(t)}`)}}var At,Xe,Dt,Ot,Qe,W,he,Te,be,et,Q,On,En,He;class ra{constructor(e,{maxQueueSize:t=1e3,maxBatchSize:r=100,scheduleDelay:s=5e3,exportTriggerRatio:a=.8}={}){A(this,Q);A(this,At);A(this,Xe);A(this,Dt);A(this,Ot);A(this,Qe);A(this,W,[]);A(this,he);A(this,Te,null);A(this,be,!1);A(this,et,null);k(this,At,t),k(this,Xe,r),k(this,Dt,s),k(this,Ot,t*a),k(this,Qe,e),k(this,he,ks),I.debug("Automatic trace export loop is not supported in this environment. You need to manually call `getGlobalTraceProvider().forceFlush()` to export traces.")}start(){k(this,et,new AbortController),U(this,Q,En).call(this)}async onTraceStart(e){await U(this,Q,On).call(this,e)}async onTraceEnd(e){}async onSpanStart(e){}async onSpanEnd(e){await U(this,Q,On).call(this,e)}async shutdown(e){var t;for(e&&p(this,he).setTimeout(()=>{var r;(r=p(this,et))==null||r.abort()},e),I.debug("Shutting down gracefully");p(this,W).length>0;){if(I.debug(`Waiting for buffer to empty. Items left: ${p(this,W).length}`),p(this,be)||await U(this,Q,He).call(this,!0),(t=p(this,et))!=null&&t.signal.aborted){I.debug("Timeout reached, force flushing"),await U(this,Q,He).call(this,!0);break}await new Promise(r=>p(this,he).setTimeout(r,500))}I.debug("Buffer empty. Exiting"),p(this,he)&&p(this,Te)&&p(this,he).clearTimeout(p(this,Te))}async forceFlush(){p(this,W).length>0&&await U(this,Q,He).call(this,!0)}}At=new WeakMap,Xe=new WeakMap,Dt=new WeakMap,Ot=new WeakMap,Qe=new WeakMap,W=new WeakMap,he=new WeakMap,Te=new WeakMap,be=new WeakMap,et=new WeakMap,Q=new WeakSet,On=async function(e){if(p(this,W).length+1>p(this,At)){I.error("Dropping trace because buffer is full");return}p(this,W).push(e),p(this,W).length>p(this,Ot)&&await U(this,Q,He).call(this)},En=function(){k(this,Te,p(this,he).setTimeout(async()=>{await U(this,Q,He).call(this),U(this,Q,En).call(this)},p(this,Dt))),typeof p(this,Te).unref=="function"&&p(this,Te).unref()},He=async function(e=!1){if(p(this,W).length!==0){if(I.debug(`Exporting batches. Force: ${e}. Buffer size: ${p(this,W).length}`),e||p(this,W).length<p(this,Xe)){const t=[...p(this,W)];k(this,W,[]),k(this,be,!0),await p(this,Qe).export(t),k(this,be,!1)}else if(p(this,W).length>0){const t=p(this,W).splice(0,p(this,Xe));k(this,be,!0),await p(this,Qe).export(t),k(this,be,!1)}}};var ee;class Es{constructor(){A(this,ee,[])}start(){for(const e of p(this,ee))e.start&&e.start()}addTraceProcessor(e){p(this,ee).push(e)}setProcessors(e){I.debug("Shutting down old processors");for(const t of p(this,ee))t.shutdown();k(this,ee,e)}async onTraceStart(e){for(const t of p(this,ee))await t.onTraceStart(e)}async onTraceEnd(e){for(const t of p(this,ee))await t.onTraceEnd(e)}async onSpanStart(e){for(const t of p(this,ee))await t.onSpanStart(e)}async onSpanEnd(e){for(const t of p(this,ee))await t.onSpanEnd(e)}async shutdown(e){for(const t of p(this,ee))await t.shutdown(e)}async forceFlush(){for(const e of p(this,ee))await e.forceFlush()}}ee=new WeakMap;let mn=null,_n=null;function Cs(){return mn||(mn=new Os),mn}function aa(){return _n||(_n=new ra(Cs())),_n}function br(){return new Date().toISOString()}function sa(){return`trace_${ta().replace(/-/g,"")}`}function Rs(){return`span_${ta().replace(/-/g,"").slice(0,24)}`}function Ns(n){return Object.fromEntries(Object.entries(n).filter(([e])=>!e.startsWith("_")))}var Et,Ct,Rt,Nt,Re,ke,Ie,Ne,$t;const nr=class nr{constructor(e,t){m(this,"type","trace.span");A(this,Et);A(this,Ct);A(this,Rt);A(this,Nt);A(this,Re);A(this,ke);A(this,Ie);A(this,Ne);A(this,$t);k(this,Ct,e.traceId),k(this,Rt,e.spanId??Rs()),k(this,Et,e.data),k(this,Re,t),k(this,Nt,e.parentId??null),k(this,Ne,e.error??null),k(this,ke,e.startedAt??null),k(this,Ie,e.endedAt??null)}get traceId(){return p(this,Ct)}get spanData(){return p(this,Et)}get spanId(){return p(this,Rt)}get parentId(){return p(this,Nt)}get previousSpan(){return p(this,$t)}set previousSpan(e){k(this,$t,e)}start(){if(p(this,ke)){I.warn("Span already started");return}k(this,ke,br()),p(this,Re).onSpanStart(this)}end(){if(p(this,Ie)){I.debug("Span already finished",this.spanData);return}k(this,Ie,br()),p(this,Re).onSpanEnd(this)}setError(e){k(this,Ne,e)}get error(){return p(this,Ne)}get startedAt(){return p(this,ke)}get endedAt(){return p(this,Ie)}clone(){var t;const e=new nr({traceId:this.traceId,spanId:this.spanId,parentId:this.parentId??void 0,data:this.spanData,startedAt:p(this,ke)??void 0,endedAt:p(this,Ie)??void 0,error:p(this,Ne)??void 0},p(this,Re));return e.previousSpan=(t=this.previousSpan)==null?void 0:t.clone(),e}toJSON(){return{object:this.type,id:this.spanId,trace_id:this.traceId,parent_id:this.parentId,started_at:this.startedAt,ended_at:this.endedAt,span_data:Ns(this.spanData),error:this.error}}};Et=new WeakMap,Ct=new WeakMap,Rt=new WeakMap,Nt=new WeakMap,Re=new WeakMap,ke=new WeakMap,Ie=new WeakMap,Ne=new WeakMap,$t=new WeakMap;let Tt=nr;class xe extends Tt{constructor(e,t){super({traceId:"no-op",spanId:"no-op",data:e},t)}start(){}end(){}setError(){}toJSON(){return null}}var tt,me;const rr=class rr{constructor(e,t){m(this,"type","trace");m(this,"traceId");m(this,"name");m(this,"groupId",null);m(this,"metadata");A(this,tt);A(this,me);this.traceId=e.traceId??sa(),this.name=e.name??"Agent workflow",this.groupId=e.groupId??null,this.metadata=e.metadata??{},k(this,tt,t??aa()),k(this,me,e.started??!1)}async start(){p(this,me)||(k(this,me,!0),await p(this,tt).onTraceStart(this))}async end(){p(this,me)&&(k(this,me,!1),await p(this,tt).onTraceEnd(this))}clone(){return new rr({traceId:this.traceId,name:this.name,groupId:this.groupId??void 0,metadata:this.metadata,started:p(this,me)})}toJSON(){return{object:this.type,id:this.traceId,workflow_name:this.name,group_id:this.groupId,metadata:this.metadata}}};tt=new WeakMap,me=new WeakMap;let bt=rr;class gn extends bt{constructor(){super({})}async start(){}async end(){}toJSON(){return null}}var H,$e,cn,oa;class $s{constructor(){A(this,cn);A(this,H);A(this,$e);k(this,H,new Es),k(this,$e,Hr.disabled),U(this,cn,oa).call(this)}registerProcessor(e){p(this,H).addTraceProcessor(e)}setProcessors(e){p(this,H).setProcessors(e)}getCurrentTrace(){return xt()}getCurrentSpan(){return St()}setDisabled(e){k(this,$e,e)}startExportLoop(){p(this,H).start()}createTrace(e){if(p(this,$e))return I.debug("Tracing is disabled, Not creating trace %o",e),new gn;const t=e.traceId??sa(),r=e.name??"Agent workflow";return I.debug("Creating trace %s with name %s",t,r),new bt({...e,name:r,traceId:t},p(this,H))}createSpan(e,t){if(p(this,$e)||e.disabled)return I.debug("Tracing is disabled, Not creating span %o",e),new xe(e.data,p(this,H));let r,s;if(t){if(t instanceof bt){if(t instanceof gn)return I.debug("Parent trace is no-op, returning NoopSpan"),new xe(e.data,p(this,H));s=t.traceId}else if(t instanceof Tt){if(t instanceof xe)return I.debug("Parent span is no-op, returning NoopSpan"),new xe(e.data,p(this,H));r=t.spanId,s=t.traceId}}else{const a=xt(),o=St();if(!a)return I.error("No active trace. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new xe(e.data,p(this,H));if(o instanceof xe||a instanceof gn)return I.debug(`Parent ${o} or ${a} is no-op, returning NoopSpan`),new xe(e.data,p(this,H));s=a.traceId,o?(I.debug("Using parent span %s",o.spanId),r=o.spanId):I.debug("No parent span, using current trace %s",a.traceId)}return s?(I.debug(`Creating span ${JSON.stringify(e.data)} with id ${e.spanId??s}`),new Tt({...e,traceId:s,parentId:r},p(this,H))):(I.error("No traceId found. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new xe(e.data,p(this,H)))}async shutdown(e){try{I.debug("Shutting down tracing provider"),await p(this,H).shutdown(e)}catch(t){I.error("Error shutting down tracing provider %o",t)}}async forceFlush(){await p(this,H).forceFlush()}}H=new WeakMap,$e=new WeakMap,cn=new WeakSet,oa=function(){if(typeof process<"u"&&typeof process.on=="function"){const e=async()=>{const t=setTimeout(()=>{console.warn("Cleanup timeout, forcing exit"),process.exit(1)},5e3);try{await this.shutdown()}finally{clearTimeout(t)}};process.on("beforeExit",e),process.on("SIGINT",async()=>{await e(),kr("SIGINT")||process.exit(130)}),process.on("SIGTERM",async()=>{await e(),kr("SIGTERM")||process.exit(0)}),process.on("unhandledRejection",async(t,r)=>{I.error("Unhandled rejection",t,r),await e(),js("unhandledRejection")||process.exit(1)})}};function kr(n){return process.listeners(n).length>1}function js(n){return process.listeners(n).length>1}let yn;function ae(){return yn||(yn=new $s),yn}function ft(n){return async(e,...t)=>Dn(async()=>{const r=n(...t);We(r);try{return r.start(),await e(r)}catch(s){throw r.setError({message:s.message,data:s.data}),s}finally{r.end(),Ce()}})}function ia(n,e){return n={},ae().createSpan({...n,data:{type:"response",...n.data}},e)}const Ps=ft(ia);function Ir(n,e){var t;return ae().createSpan({...n,data:{type:"agent",name:((t=n==null?void 0:n.data)==null?void 0:t.name)??"Agent",...n==null?void 0:n.data}},e)}function Ms(n,e){var t,r;return ae().createSpan({...n,data:{type:"function",input:((t=n==null?void 0:n.data)==null?void 0:t.input)??"",output:((r=n==null?void 0:n.data)==null?void 0:r.output)??"",...n==null?void 0:n.data}},e)}const Ar=ft(Ms);function Ls(n,e){return ae().createSpan({...n,data:{type:"handoff",...n==null?void 0:n.data}},e)}const Us=ft(Ls);function ua(n,e){return ae().createSpan({...n,data:{type:"generation",...n==null?void 0:n.data}},e)}const Zs=ft(ua);function Fs(n,e){return ae().createSpan({...n,data:{type:"guardrail",triggered:!1,...n==null?void 0:n.data}},e)}const Dr=ft(Fs);function Js(n,e){return ae().createSpan({...n,data:{type:"mcp_tools",...n==null?void 0:n.data}},e)}const Gs=ft(Js);function Bs(n){ae().registerProcessor(n)}function Vs(n){ae().setProcessors(n)}class ca{on(e,t){return this.eventEmitter.on(e,t),this.eventEmitter}off(e,t){return this.eventEmitter.off(e,t),this.eventEmitter}emit(e,...t){return this.eventEmitter.emit(e,...t)}once(e,t){return this.eventEmitter.once(e,t),this.eventEmitter}}class zs extends ca{constructor(){super(...arguments);m(this,"eventEmitter",new ea)}}class Hs extends ca{constructor(){super(...arguments);m(this,"eventEmitter",new ea)}}function Or({name:n,execute:e}){return{type:"input",name:n,guardrailFunction:e,async run(t){return{guardrail:{type:"input",name:n},output:await e(t)}}}}function Er({name:n,execute:e}){return{type:"output",name:n,guardrailFunction:e,async run(t){return{guardrail:{type:"output",name:n},agent:t.agent,agentOutput:t.agentOutput,output:await e(t)}}}}function qs(n){return JSON.stringify({assistant:n.name})}function Ws(n){return`transfer_to_${qt(n.name)}`}function Ks(n){return`Handoff to the ${n.name} agent to handle the request. ${n.handoffDescription??""}`}class la{constructor(e,t){m(this,"toolName");m(this,"toolDescription");m(this,"inputJsonSchema",{type:"object",properties:{},required:[],additionalProperties:!1});m(this,"strictJsonSchema",!0);m(this,"onInvokeHandoff");m(this,"agentName");m(this,"inputFilter");m(this,"agent");this.agentName=e.name,this.onInvokeHandoff=t,this.toolName=Ws(e),this.toolDescription=Ks(e),this.agent=e}getHandoffAsFunctionTool(){return{type:"function",name:this.toolName,description:this.toolDescription,parameters:this.inputJsonSchema,strict:this.strictJsonSchema}}}function da(n,e={}){let t;const r=!!e.onHandoff,s=!!e.inputType;if(!(r===s))throw new F("You must provide either both `onHandoff` and `inputType` or neither.");async function o(c,l){var d;if(t){if(!l)throw Ke({message:`Handoff function expected non empty input but got: ${l}`,data:{details:"input is empty"}}),new ge("Handoff function expected non empty input");try{const y=await t(l);e.onHandoff&&await e.onHandoff(c,y)}catch(y){throw Ke({message:"Invalid JSON provided",data:{}}),I.dontLogToolData||I.error(`Invalid JSON when parsing: ${l}. Error: ${y}`),new ge("Invalid JSON provided")}}else await((d=e.onHandoff)==null?void 0:d.call(e,c));return n}const i=new la(n,o);if(e.inputType){const c=Jn(e.inputType,i.toolName);i.inputJsonSchema=c.schema,i.strictJsonSchema=!0,t=c.parser}return e.toolNameOverride&&(i.toolName=e.toolNameOverride),e.toolDescriptionOverride&&(i.toolDescription=e.toolDescriptionOverride),e.inputFilter&&(i.inputFilter=e.inputFilter),i}function Cr(n){return n instanceof la?n:da(n)}let Cn;function Ys(n){Cn=n}function Xs(){if(typeof Cn>"u")throw new Error("No default model provider set. Make sure to set a provider using setDefaultModelProvider before calling getDefaultModelProvider or pass an explicit provider.");return Cn}const q=h({providerData:V(u(),$()).optional()}),Je=q.extend({id:u().optional()}),Qs=q.extend({type:f("refusal"),refusal:u()}),eo=q.extend({type:f("output_text"),text:u()}),Hn=q.extend({type:f("input_text"),text:u()}),to=q.extend({type:f("input_image"),image:u().or(h({id:u()})).describe("Could be a URL, base64 or an object with a file ID.")}),no=q.extend({type:f("input_file"),file:u().describe("Either base64 encoded file data or a publicly accessible file URL").or(h({id:u().describe("OpenAI file ID")})).or(h({url:u().describe("Publicly accessible PDF file URL")})).describe("Contents of the file or an object with a file ID.")}),pa=q.extend({type:f("audio"),audio:u().or(h({id:u()})).describe("Base64 encoded audio data or file id"),format:u().nullable().optional(),transcript:u().nullable().optional()}),ro=q.extend({type:f("image"),image:u().describe("Base64 encoded image data")}),ao=q.extend({type:f("text"),text:u()}),so=q.extend({type:f("image"),data:u().describe("Base64 encoded image data"),mediaType:u().describe("IANA media type of the image")}),oo=q.extend({type:f("computer_screenshot"),data:u().describe("Base64 encoded image data or URL")}),io=re("type",[h({type:f("screenshot")}),h({type:f("click"),x:T(),y:T(),button:J(["left","right","wheel","back","forward"])}),h({type:f("double_click"),x:T(),y:T()}),h({type:f("scroll"),x:T(),y:T(),scroll_x:T(),scroll_y:T()}),h({type:f("type"),text:u()}),h({type:f("wait")}),h({type:f("move"),x:T(),y:T()}),h({type:f("keypress"),keys:P(u())}),h({type:f("drag"),path:P(h({x:T(),y:T()}))})]),uo=re("type",[eo,Qs,Hn,pa,ro]),qn=Je.extend({type:f("message").optional()}),ln=qn.extend({role:f("assistant"),status:J(["in_progress","completed","incomplete"]),content:P(uo)}),co=re("type",[Hn,to,no,pa]),fa=qn.extend({role:f("user"),content:P(co).or(u())}),ha=qn.extend({role:f("system"),content:u()});re("role",[ha,ln,fa]);const kt=Je.extend({type:f("hosted_tool_call"),name:u().describe("The name of the hosted tool"),arguments:u().describe("The arguments of the hosted tool call").optional(),status:u().optional(),output:u().optional()}),It=Je.extend({type:f("function_call"),callId:u().describe("The ID of the tool call"),name:u().describe("The name of the function"),status:J(["in_progress","completed","incomplete"]).optional(),arguments:u()}),Rn=Je.extend({type:f("function_call_result"),name:u().describe("The name of the tool"),callId:u().describe("The ID of the tool call"),status:J(["in_progress","completed","incomplete"]),output:re("type",[ao,so])}),Wn=Je.extend({type:f("computer_call"),callId:u().describe("The ID of the computer call"),status:J(["in_progress","completed","incomplete"]),action:io}),lo=Je.extend({type:f("computer_call_result"),callId:u().describe("The ID of the computer call"),output:oo}),po=re("type",[Wn,It,kt]),Kn=q.extend({id:u().optional(),type:f("reasoning"),content:P(Hn)}),ma=Je.extend({type:f("unknown")}),Yn=re("type",[ln,kt,It,Wn,Kn,ma]),fo=Qr([fa,ln,ha,kt,It,Wn,Rn,lo,Kn,ma]),ho=h({requests:T().optional(),inputTokens:T(),outputTokens:T(),totalTokens:T(),inputTokensDetails:V(u(),T()).optional(),outputTokensDetails:V(u(),T()).optional()}),_a=q.extend({type:f("output_text_delta"),delta:u()}),mo=q.extend({type:f("response_started")}),ga=q.extend({type:f("response_done"),response:q.extend({id:u(),usage:ho,output:P(Yn)})}),_o=q.extend({type:f("model"),event:$().describe("The event from the model")});re("type",[_a,ga,mo,_o]);class lt{constructor(e){m(this,"requests");m(this,"inputTokens");m(this,"outputTokens");m(this,"totalTokens");m(this,"inputTokensDetails",[]);m(this,"outputTokensDetails",[]);typeof e>"u"?(this.requests=0,this.inputTokens=0,this.outputTokens=0,this.totalTokens=0,this.inputTokensDetails=[],this.outputTokensDetails=[]):(this.requests=(e==null?void 0:e.requests)??1,this.inputTokens=(e==null?void 0:e.inputTokens)??0,this.outputTokens=(e==null?void 0:e.outputTokens)??0,this.totalTokens=(e==null?void 0:e.totalTokens)??0,this.inputTokensDetails=e!=null&&e.inputTokensDetails?[e.inputTokensDetails]:[],this.outputTokensDetails=e!=null&&e.outputTokensDetails?[e.outputTokensDetails]:[])}add(e){this.requests+=e.requests,this.inputTokens+=e.inputTokens,this.outputTokens+=e.outputTokens,this.totalTokens+=e.totalTokens,e.inputTokensDetails&&this.inputTokensDetails.push(...e.inputTokensDetails),e.outputTokensDetails&&this.outputTokensDetails.push(...e.outputTokensDetails)}}var te;class gt{constructor(e={}){m(this,"context");m(this,"usage");A(this,te);this.context=e,this.usage=new lt,k(this,te,new Map)}_rebuildApprovals(e){k(this,te,new Map(Object.entries(e)))}isToolApproved({toolName:e,callId:t}){const r=p(this,te).get(e);if((r==null?void 0:r.approved)===!0&&r.rejected===!0)return I.warn("Tool is permanently approved and rejected at the same time. Approval takes precedence"),!0;if((r==null?void 0:r.approved)===!0)return!0;if((r==null?void 0:r.rejected)===!0)return!1;const s=Array.isArray(r==null?void 0:r.approved)?r.approved.includes(t):!1,a=Array.isArray(r==null?void 0:r.rejected)?r.rejected.includes(t):!1;if(s&&a)return I.warn(`Tool call ${t} is both approved and rejected at the same time. Approval takes precedence`),!0;if(s)return!0;if(a)return!1}approveTool(e,{alwaysApprove:t=!1}={}){const r=e.rawItem.name;if(t){p(this,te).set(r,{approved:!0,rejected:[]});return}const s=p(this,te).get(r)??{approved:[],rejected:[]};if(Array.isArray(s.approved)){const a="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;s.approved.push(a)}p(this,te).set(r,s)}rejectTool(e,{alwaysReject:t=!1}={}){const r=e.rawItem.name;if(t){p(this,te).set(r,{approved:!1,rejected:!0});return}const s=p(this,te).get(r)??{approved:[],rejected:[]};if(Array.isArray(s.rejected)){const a="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;s.rejected.push(a)}p(this,te).set(r,s)}toJSON(){return{context:this.context,usage:this.usage,approvals:Object.fromEntries(p(this,te).entries())}}}te=new WeakMap;class ya{constructor(e){m(this,"state");this.state=e}get history(){return un(this.input,this.newItems)}get output(){return un([],this.newItems)}get input(){return this.state._originalInput}get newItems(){return this.state._generatedItems}get rawResponses(){return this.state._modelResponses}get lastResponseId(){const e=this.rawResponses;return e&&e.length>0?e[e.length-1].responseId:void 0}get lastAgent(){return this.state._currentAgent}get inputGuardrailResults(){return this.state._inputGuardrailResults}get outputGuardrailResults(){return this.state._outputGuardrailResults}get interruptions(){var e;return((e=this.state._currentStep)==null?void 0:e.type)==="next_step_interruption"?this.state._currentStep.data.interruptions:[]}get finalOutput(){var e;if(((e=this.state._currentStep)==null?void 0:e.type)==="next_step_final_output")return this.state._currentAgent.processFinalOutput(this.state._currentStep.output);I.warn("Accessed finalOutput before agent run is completed.")}}class vn extends ya{constructor(e){super(e)}}var jt,nt,oe,Ae,rt,Pt,Mt,Lt;class go extends ya{constructor(t={}){super(t.state);m(this,"currentTurn",0);m(this,"maxTurns");A(this,jt,null);A(this,nt);A(this,oe);A(this,Ae);A(this,rt);A(this,Pt);A(this,Mt);A(this,Lt,!1);k(this,nt,t.signal),p(this,nt)&&p(this,nt).addEventListener("abort",async()=>{await p(this,Ae).cancel()}),k(this,Ae,new xs({start:r=>{k(this,oe,r)},cancel:()=>{k(this,Lt,!0)}})),k(this,rt,new Promise((r,s)=>{k(this,Pt,r),k(this,Mt,s)}))}get currentAgent(){return this.lastAgent}_addItem(t){var r;this.cancelled||(r=p(this,oe))==null||r.enqueue(t)}_done(){var t;!this.cancelled&&p(this,oe)&&(p(this,oe).close(),k(this,oe,void 0),(t=p(this,Pt))==null||t.call(this))}_raiseError(t){var r;!this.cancelled&&p(this,oe)&&(p(this,oe).error(t),k(this,oe,void 0)),k(this,jt,t),(r=p(this,Mt))==null||r.call(this,t),p(this,rt).catch(s=>{I.debug(`Resulted in an error: ${s}`)})}get cancelled(){return p(this,Lt)}toStream(){return p(this,Ae)}get completed(){return p(this,rt)}get error(){return p(this,jt)}toTextStream(t={}){const r=p(this,Ae).pipeThrough(new Ss({transform(s,a){if(s.type==="raw_model_stream_event"&&s.data.type==="output_text_delta"){const o=_a.parse(s.data);a.enqueue(o.delta)}}}));return t.compatibleWithNodeStreams?ws.fromWeb(r):r}[Symbol.asyncIterator](){return p(this,Ae)[Symbol.asyncIterator]()}}jt=new WeakMap,nt=new WeakMap,oe=new WeakMap,Ae=new WeakMap,rt=new WeakMap,Pt=new WeakMap,Mt=new WeakMap,Lt=new WeakMap;function Rr(n){return n.type==="function"?{type:"function",name:n.name,description:n.description,parameters:n.parameters,strict:n.strict}:n.type==="computer"?{type:"computer",name:n.name,environment:n.computer.environment,dimensions:n.computer.dimensions}:{type:"hosted_tool",name:n.name,providerData:n.providerData}}function Nr(n){return{toolName:n.toolName,toolDescription:n.toolDescription,inputJsonSchema:n.inputJsonSchema,strictJsonSchema:n.strictJsonSchema}}class Ge{constructor(){m(this,"type","base_item");m(this,"rawItem")}toJSON(){return{type:this.type,rawItem:this.rawItem}}}class dn extends Ge{constructor(t,r){super();m(this,"rawItem");m(this,"agent");m(this,"type","message_output_item");this.rawItem=t,this.agent=r}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}get content(){let t="";for(const r of this.rawItem.content)r.type==="output_text"&&(t+=r.text);return t}}class Me extends Ge{constructor(t,r){super();m(this,"rawItem");m(this,"agent");m(this,"type","tool_call_item");this.rawItem=t,this.agent=r}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class dt extends Ge{constructor(t,r,s){super();m(this,"rawItem");m(this,"agent");m(this,"output");m(this,"type","tool_call_output_item");this.rawItem=t,this.agent=r,this.output=s}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON(),output:it(this.output)}}}class Xn extends Ge{constructor(t,r){super();m(this,"rawItem");m(this,"agent");m(this,"type","reasoning_item");this.rawItem=t,this.agent=r}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Qn extends Ge{constructor(t,r){super();m(this,"rawItem");m(this,"agent");m(this,"type","handoff_call_item");this.rawItem=t,this.agent=r}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class er extends Ge{constructor(t,r,s){super();m(this,"rawItem");m(this,"sourceAgent");m(this,"targetAgent");m(this,"type","handoff_output_item");this.rawItem=t,this.sourceAgent=r,this.targetAgent=s}toJSON(){return{...super.toJSON(),sourceAgent:this.sourceAgent.toJSON(),targetAgent:this.targetAgent.toJSON()}}}class we extends Ge{constructor(t,r){super();m(this,"rawItem");m(this,"agent");m(this,"type","tool_approval_item");this.rawItem=t,this.agent=r}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}function va(n){if(n.type!=="message"||n.role!=="assistant")return;const e=n.content[n.content.length-1];if(e.type==="output_text")return e.text}function yo(n){return n.output.length===0?"":va(n.output[n.output.length-1])||""}class vo{constructor(e){m(this,"data");m(this,"type","raw_model_stream_event");this.data=e}}class wo{constructor(e,t){m(this,"name");m(this,"item");m(this,"type","run_item_stream_event");this.name=e,this.item=t}}class xo{constructor(e){m(this,"agent");m(this,"type","agent_updated_stream_event");this.agent=e}}function $r(n,e,t,r){var b;const s=[],a=[],o=[],i=[],c=[],l=[],d=new Map(r.map(v=>[v.toolName,v])),y=new Map(t.filter(v=>v.type==="function").map(v=>[v.name,v])),w=t.find(v=>v.type==="computer"),E=new Map(t.filter(v=>{var N;return v.type==="hosted_tool"&&((N=v.providerData)==null?void 0:N.type)==="mcp"}).map(v=>v).map(v=>[v.providerData.server_label,v]));for(const v of n.output){if(v.type==="message")v.role==="assistant"&&s.push(new dn(v,e));else if(v.type==="hosted_tool_call"){s.push(new Me(v,e));const L=v.name;if(l.push(L),((b=v.providerData)==null?void 0:b.type)==="mcp_approval_request"||v.name==="mcp_approval_request"){const z=v.providerData,X=z.server_label,Be=E.get(X);if(typeof Be>"u"){const mt=`MCP server (${X}) not found in Agent (${e.name})`;throw Ke({message:mt,data:{mcp_server_label:X}}),new ge(mt)}const ht=new we({type:"hosted_tool_call",name:z.name,id:z.id,status:"in_progress",providerData:z},e);c.push({requestItem:ht,mcpTool:Be}),Be.providerData.on_approval||s.push(ht)}}else if(v.type==="reasoning")s.push(new Xn(v,e));else if(v.type==="computer_call"){if(s.push(new Me(v,e)),l.push("computer_use"),!w)throw Ke({message:"Model produced computer action without a computer tool.",data:{agent_name:e.name}}),new ge("Model produced computer action without a computer tool.");i.push({toolCall:v,computer:w})}if(v.type!=="function_call")continue;l.push(v.name);const N=d.get(v.name);if(N)s.push(new Qn(v,e)),a.push({toolCall:v,handoff:N});else{const L=y.get(v.name);if(!L)throw Ke({message:`Tool ${v.name} not found in agent ${e.name}.`,data:{tool_name:v.name,agent_name:e.name}}),new ge(`Tool ${v.name} not found in agent ${e.name}.`);s.push(new Me(v,e)),o.push({toolCall:v,tool:L})}}return{newItems:s,handoffs:a,functions:o,computerActions:i,mcpApprovalRequests:c,toolsUsed:l,hasToolsOrApprovalsToRun(){return a.length>0||o.length>0||c.length>0||i.length>0}}}const So=re("type",[h({type:f("next_step_handoff"),newAgent:$()}),h({type:f("next_step_final_output"),output:u()}),h({type:f("next_step_run_again")}),h({type:f("next_step_interruption"),data:V(u(),$())})]);class ie{constructor(e,t,r,s,a){m(this,"originalInput");m(this,"modelResponse");m(this,"preStepItems");m(this,"newStepItems");m(this,"nextStep");this.originalInput=e,this.modelResponse=t,this.preStepItems=r,this.newStepItems=s,this.nextStep=a}get generatedItems(){return this.preStepItems.concat(this.newStepItems)}}function jr(n,e,t){return n.resetToolChoice&&e.hasUsedTools(n)?{...t,toolChoice:void 0}:t}async function Pr(n,e,t,r,s,a,o){const i=t.filter(b=>b instanceof we&&"callId"in b.rawItem&&b.rawItem.type==="function_call").map(b=>b.rawItem.callId),c=s.functions.filter(b=>i.includes(b.toolCall.callId)),l=await wa(n,c,a,o),d=l.map(b=>b.runItem),y=s.mcpApprovalRequests.filter(b=>{var v;return b.requestItem.type==="tool_approval_item"&&b.requestItem.rawItem.type==="hosted_tool_call"&&((v=b.requestItem.rawItem.providerData)==null?void 0:v.type)==="mcp_approval_request"});for(const b of y){const v=b.requestItem.rawItem.id,N=o._context.isToolApproved({toolName:b.requestItem.rawItem.name,callId:v});if(typeof N<"u"){const L={approve:N,approval_request_id:v,reason:void 0};d.push(new Me({type:"hosted_tool_call",name:"mcp_approval_response",providerData:L},n))}}const w=await xa(n,l,o),E=t.filter(b=>!(b instanceof we));return w.isFinalOutput?(a.emit("agent_end",o._context,n,w.finalOutput),n.emit("agent_end",o._context,w.finalOutput),new ie(e,r,E,d,{type:"next_step_final_output",output:w.finalOutput})):w.isInterrupted?new ie(e,r,E,d,{type:"next_step_interruption",data:{interruptions:w.interruptions}}):new ie(e,r,E,d,{type:"next_step_run_again"})}async function Mr(n,e,t,r,s,a,o){const i=t;let c=s.newItems;const[l,d]=await Promise.all([wa(n,s.functions,a,o),bo(n,s.computerActions,a,o._context)]);if(c=c.concat(l.map(b=>b.runItem)),c=c.concat(d),s.mcpApprovalRequests.length>0)for(const b of s.mcpApprovalRequests){const v=b.mcpTool.providerData,N=b.requestItem.rawItem.providerData;if(v.on_approval){const L=await v.on_approval(o._context,b.requestItem),z={approve:L.approve,approval_request_id:N.id,reason:L.reason};c.push(new Me({type:"hosted_tool_call",name:"mcp_approval_response",providerData:z},n))}else{c.push(b.requestItem);const L={type:"hosted_mcp_tool_approval",tool:b.mcpTool,runItem:new we({type:"hosted_tool_call",name:N.name,id:N.id,arguments:N.arguments,status:"in_progress",providerData:N},n)};l.push(L)}}if(s.handoffs.length>0)return await ko(n,e,i,c,r,s.handoffs,a,o._context);const y=await xa(n,l,o);if(y.isFinalOutput)return a.emit("agent_end",o._context,n,y.finalOutput),n.emit("agent_end",o._context,y.finalOutput),new ie(e,r,i,c,{type:"next_step_final_output",output:y.finalOutput});if(y.isInterrupted)return new ie(e,r,i,c,{type:"next_step_interruption",data:{interruptions:y.interruptions}});const w=c.filter(b=>b instanceof dn),E=w.length>0?va(w[w.length-1].rawItem):void 0;if(!E)return new ie(e,r,i,c,{type:"next_step_run_again"});if(n.outputType==="text"&&!s.hasToolsOrApprovalsToRun())return new ie(e,r,i,c,{type:"next_step_final_output",output:E});if(n.outputType!=="text"&&E){const{parser:b}=Jn(n.outputType,"final_output"),[v]=await Fn(()=>b(E));if(v)throw Ke({message:"Invalid output type",data:{error:String(v)}}),new ge("Invalid output type");return new ie(e,r,i,c,{type:"next_step_final_output",output:E})}return new ie(e,r,i,c,{type:"next_step_run_again"})}function on(n,e){return{type:"function_call_result",name:n.name,callId:n.callId,status:"completed",output:{type:"text",text:it(e)}}}async function wa(n,e,t,r){async function s(a){let o=a.toolCall.arguments;if(a.tool.parameters&&(ot(a.tool.parameters)?o=a.tool.parameters.parse(o):o=JSON.parse(o)),await a.tool.needsApproval(r._context,o,a.toolCall.callId)){const c=r._context.isToolApproved({toolName:a.tool.name,callId:a.toolCall.callId});if(c===!1)return Ar(async l=>{const d="Tool execution was not approved.";return l.setError({message:d,data:{tool_name:a.tool.name,error:`Tool execution for ${a.toolCall.callId} was manually rejected by user.`}}),l.spanData.output=d,{type:"function_output",tool:a.tool,output:d,runItem:new dt(on(a.toolCall,d),n,d)}},{data:{name:a.tool.name}});if(c!==!0)return{type:"function_approval",tool:a.tool,runItem:new we(a.toolCall,n)}}return Ar(async c=>{t.config.traceIncludeSensitiveData&&(c.spanData.input=a.toolCall.arguments);try{t.emit("agent_tool_start",r._context,n,a.tool,{toolCall:a.toolCall}),n.emit("agent_tool_start",r._context,a.tool,{toolCall:a.toolCall});const l=await a.tool.invoke(r._context,a.toolCall.arguments),d=it(l);return t.emit("agent_tool_end",r._context,n,a.tool,d,{toolCall:a.toolCall}),n.emit("agent_tool_end",r._context,a.tool,d,{toolCall:a.toolCall}),t.config.traceIncludeSensitiveData&&(c.spanData.output=d),{type:"function_output",tool:a.tool,output:l,runItem:new dt(on(a.toolCall,l),n,l)}}catch(l){throw c.setError({message:"Error running tool",data:{tool_name:a.tool.name,error:String(l)}}),l}},{data:{name:a.tool.name}})}try{return await Promise.all(e.map(s))}catch(a){throw new La(`Failed to run function tools: ${a}`,a,r)}}async function To(n,e){const t=e.action;let r;switch(t.type){case"click":await n.click(t.x,t.y,t.button);break;case"double_click":await n.doubleClick(t.x,t.y);break;case"drag":await n.drag(t.path.map(s=>[s.x,s.y]));break;case"keypress":await n.keypress(t.keys);break;case"move":await n.move(t.x,t.y);break;case"screenshot":r=await n.screenshot();break;case"scroll":await n.scroll(t.x,t.y,t.scroll_x,t.scroll_y);break;case"type":await n.type(t.text);break;case"wait":await n.wait();break}if(typeof r<"u"||typeof n.screenshot=="function"&&(r=await n.screenshot(),typeof r<"u"))return r;throw new Error("Computer does not implement screenshot()")}async function bo(n,e,t,r,s=void 0){const a=s??I,o=[];for(const i of e){const c=i.computer.computer,l=i.toolCall;t.emit("agent_tool_start",r,n,i.computer,{toolCall:l}),typeof n.emit=="function"&&n.emit("agent_tool_start",r,i.computer,{toolCall:l});let d;try{d=await To(c,l)}catch(E){a.error("Failed to execute computer action:",E),d=""}t.emit("agent_tool_end",r,n,i.computer,d,{toolCall:l}),typeof n.emit=="function"&&n.emit("agent_tool_end",r,i.computer,d,{toolCall:l});const y=d?`data:image/png;base64,${d}`:"",w={type:"computer_call_result",callId:l.callId,output:{type:"computer_screenshot",data:y}};o.push(new dt(w,n,y))}return o}async function ko(n,e,t,r,s,a,o,i){if(r=[...r],a.length===0)return I.warn("Incorrectly called executeHandoffCalls with no handoffs. This should not happen. Moving on."),new ie(e,s,t,r,{type:"next_step_run_again"});if(a.length>1){const l="Multiple handoffs detected, ignoring this one.";for(let d=1;d<a.length;d++)r.push(new dt(on(a[d].toolCall,l),n,l))}const c=a[0];return Us(async l=>{const d=c.handoff,y=await d.onInvokeHandoff(i,c.toolCall.arguments);if(l.spanData.to_agent=y.name,a.length>1){const E=a.map(b=>b.handoff.agentName);l.setError({message:"Multiple handoffs requested",data:{requested_agents:E}})}r.push(new er(on(c.toolCall,qs(y)),n,y)),o.emit("agent_handoff",i,n,y),n.emit("agent_handoff",i,y);const w=d.inputFilter??o.config.handoffInputFilter;if(w){I.debug("Filtering inputs for handoff"),typeof w!="function"&&l.setError({message:"Invalid input filter",data:{details:"not callable"}});const E={inputHistory:Array.isArray(e)?[...e]:e,preHandoffItems:[...t],newItems:[...r]},b=w(E);e=b.inputHistory,t=b.preHandoffItems,r=b.newItems}return new ie(e,s,t,r,{type:"next_step_handoff",newAgent:y})},{data:{from_agent:n.name}})}const zt={isFinalOutput:!1,isInterrupted:void 0};async function xa(n,e,t){if(e.length===0)return zt;const r=e.filter(o=>o.runItem instanceof we).map(o=>o.runItem);if(r.length>0)return{isFinalOutput:!1,isInterrupted:!0,interruptions:r};if(n.toolUseBehavior==="run_llm_again")return zt;const s=e[0];if(n.toolUseBehavior==="stop_on_first_tool")return(s==null?void 0:s.type)==="function_output"?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:it(s.output)}:zt;const a=n.toolUseBehavior;if(typeof a=="object"){const o=e.find(i=>a.stopAtToolNames.includes(i.tool.name));return(o==null?void 0:o.type)==="function_output"?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:it(o.output)}:zt}if(typeof a=="function")return a(t._context,e);throw new F(`Invalid toolUseBehavior: ${a}`,t)}function Lr(n,e){for(const t of e.newStepItems){let r;if(t instanceof dn)r="message_output_created";else if(t instanceof Qn)r="handoff_requested";else if(t instanceof er)r="handoff_occurred";else if(t instanceof Me)r="tool_called";else if(t instanceof dt)r="tool_output";else if(t instanceof Xn)r="reasoning_item_created";else if(t instanceof we)r="tool_approval_requested";else{I.warn("Unknown item type: ",t);continue}n._addItem(new wo(r,t))}}var at;class Ur{constructor(){A(this,at,new Map)}addToolUse(e,t){p(this,at).set(e,t)}hasUsedTools(e){return p(this,at).has(e)}toJSON(){return Object.fromEntries(Array.from(p(this,at).entries()).map(([e,t])=>[e.name,t]))}}at=new WeakMap;const Ht="1.0",Io=f(Ht),ue=h({name:u()}),Ao=h({object:f("trace.span"),id:u(),trace_id:u(),parent_id:u().nullable(),started_at:u().nullable(),ended_at:u().nullable(),error:h({message:u(),data:V(u(),$()).optional()}).nullable(),span_data:V(u(),$())}),Sa=Ao.extend({previous_span:ms(()=>Sa).optional()}),Ta=h({requests:T(),inputTokens:T(),outputTokens:T(),totalTokens:T()}),Zr=h({usage:Ta,output:P(Yn),responseId:u().optional(),providerData:V(u(),$()).optional()}),ba=re("type",[h({type:f("message_output_item"),rawItem:ln,agent:ue}),h({type:f("tool_call_item"),rawItem:po.or(kt),agent:ue}),h({type:f("tool_call_output_item"),rawItem:Rn,agent:ue,output:u()}),h({type:f("reasoning_item"),rawItem:Kn,agent:ue}),h({type:f("handoff_call_item"),rawItem:It,agent:ue}),h({type:f("handoff_output_item"),rawItem:Rn,sourceAgent:ue,targetAgent:ue}),h({type:f("tool_approval_item"),rawItem:It.or(kt),agent:ue})]),Do=h({object:f("trace"),id:u(),workflow_name:u(),group_id:u().nullable(),metadata:V(u(),$())}),Oo=h({newItems:P(ba),toolsUsed:P(u()),handoffs:P(h({toolCall:$(),handoff:$()})),functions:P(h({toolCall:$(),tool:$()})),computerActions:P(h({toolCall:$(),computer:$()})),mcpApprovalRequests:P(h({requestItem:h({rawItem:h({type:f("hosted_tool_call"),name:u(),arguments:u().optional(),status:u().optional(),output:u().optional(),providerData:V(u(),$()).nullable().optional()})}),mcpTool:h({type:f("hosted_tool"),name:f("hosted_mcp"),providerData:V(u(),$())})})).optional()}),ka=h({tripwireTriggered:yt(),outputInfo:$()}),Eo=h({guardrail:h({type:f("input"),name:u()}),output:ka}),Co=h({guardrail:h({type:f("output"),name:u()}),agentOutput:$(),agent:ue,output:ka}),Fr=h({$schemaVersion:Io,currentTurn:T(),currentAgent:ue,originalInput:u().or(P(fo)),modelResponses:P(Zr),context:h({usage:Ta,approvals:V(u(),h({approved:P(u()).or(yt()),rejected:P(u()).or(yt())})),context:V(u(),$())}),toolUseTracker:V(u(),P(u())),maxTurns:T(),currentAgentSpan:Sa.nullable().optional(),noActiveAgentRun:yt(),inputGuardrailResults:P(Eo),outputGuardrailResults:P(Co),currentStep:So.optional(),lastModelResponse:Zr.optional(),generatedItems:P(ba),lastProcessedResponse:Oo.optional(),trace:Do.nullable()});class Ee{constructor(e,t,r,s){m(this,"_currentTurn",0);m(this,"_currentAgent");m(this,"_originalInput");m(this,"_modelResponses");m(this,"_currentAgentSpan");m(this,"_context");m(this,"_toolUseTracker");m(this,"_generatedItems");m(this,"_maxTurns");m(this,"_noActiveAgentRun",!0);m(this,"_lastTurnResponse");m(this,"_inputGuardrailResults");m(this,"_outputGuardrailResults");m(this,"_currentStep");m(this,"_lastProcessedResponse");m(this,"_trace",null);this._context=e,this._originalInput=structuredClone(t),this._modelResponses=[],this._currentAgentSpan=void 0,this._currentAgent=r,this._toolUseTracker=new Ur,this._generatedItems=[],this._maxTurns=s,this._inputGuardrailResults=[],this._outputGuardrailResults=[],this._trace=xt()}getInterruptions(){var e;return((e=this._currentStep)==null?void 0:e.type)!=="next_step_interruption"?[]:this._currentStep.data.interruptions}approve(e,t={alwaysApprove:!1}){this._context.approveTool(e,t)}reject(e,t={alwaysReject:!1}){this._context.rejectTool(e,t)}toJSON(){var r;const e={$schemaVersion:Ht,currentTurn:this._currentTurn,currentAgent:{name:this._currentAgent.name},originalInput:this._originalInput,modelResponses:this._modelResponses.map(s=>({usage:{requests:s.usage.requests,inputTokens:s.usage.inputTokens,outputTokens:s.usage.outputTokens,totalTokens:s.usage.totalTokens},output:s.output,responseId:s.responseId,providerData:s.providerData})),context:this._context.toJSON(),toolUseTracker:this._toolUseTracker.toJSON(),maxTurns:this._maxTurns,currentAgentSpan:(r=this._currentAgentSpan)==null?void 0:r.toJSON(),noActiveAgentRun:this._noActiveAgentRun,inputGuardrailResults:this._inputGuardrailResults,outputGuardrailResults:this._outputGuardrailResults.map(s=>({...s,agent:s.agent.toJSON()})),currentStep:this._currentStep,lastModelResponse:this._lastTurnResponse,generatedItems:this._generatedItems.map(s=>s.toJSON()),lastProcessedResponse:this._lastProcessedResponse,trace:this._trace?this._trace.toJSON():null},t=Fr.safeParse(e);if(!t.success)throw new Ma(`Failed to serialize run state. ${t.error.message}`);return t.data}toString(){return JSON.stringify(this.toJSON())}static async fromString(e,t){var y,w,E,b,v;const[r,s]=await Fn(()=>JSON.parse(t));if(r)throw new F(`Failed to parse run state. ${r instanceof Error?r.message:String(r)}`);const a=s.$schemaVersion;if(!a)throw new F("Run state is missing schema version");if(a!==Ht)throw new F(`Run state schema version ${a} is not supported. Please use version ${Ht}`);const o=Fr.parse(JSON.parse(t)),i=Ro(e),c=new gt(o.context.context);c._rebuildApprovals(o.context.approvals);const l=i.get(o.currentAgent.name);if(!l)throw new F(`Agent ${o.currentAgent.name} not found`);const d=new Ee(c,"",l,o.maxTurns);d._currentTurn=o.currentTurn,d._toolUseTracker=new Ur;for(const[N,L]of Object.entries(o.toolUseTracker))d._toolUseTracker.addToolUse(i.get(N),L);if(o.currentAgentSpan){o.trace||I.warn("Trace is not set, skipping tracing setup");const N=ae().createTrace({traceId:(y=o.trace)==null?void 0:y.id,name:(w=o.trace)==null?void 0:w.workflow_name,groupId:((E=o.trace)==null?void 0:E.group_id)??void 0,metadata:(b=o.trace)==null?void 0:b.metadata});d._currentAgentSpan=Ia(N,o.currentAgentSpan),d._trace=N}return d._noActiveAgentRun=o.noActiveAgentRun,d._inputGuardrailResults=o.inputGuardrailResults,d._outputGuardrailResults=o.outputGuardrailResults.map(N=>({...N,agent:i.get(N.agent.name)})),d._currentStep=o.currentStep,d._originalInput=o.originalInput,d._modelResponses=o.modelResponses.map(Jr),d._lastTurnResponse=o.lastModelResponse?Jr(o.lastModelResponse):void 0,d._generatedItems=o.generatedItems.map(N=>Aa(N,i)),d._lastProcessedResponse=o.lastProcessedResponse?await No(i,d._currentAgent,o.lastProcessedResponse):void 0,((v=o.currentStep)==null?void 0:v.type)==="next_step_handoff"&&(d._currentStep={type:"next_step_handoff",newAgent:i.get(o.currentStep.newAgent.name)}),d}}function Ro(n){const e=new Map,t=[n];for(;t.length>0;){const r=t.shift();if(!e.has(r.name)){e.set(r.name,r);for(const s of r.handoffs)s instanceof pt?e.has(s.name)||t.push(s):s.agent&&(e.has(s.agent.name)||t.push(s.agent))}}return e}function Ia(n,e){const t=e.span_data,r=e.previous_span?Ia(n,e.previous_span):void 0,s=ae().createSpan({spanId:e.id,traceId:e.trace_id,parentId:e.parent_id??void 0,startedAt:e.started_at??void 0,endedAt:e.ended_at??void 0,data:t},n);return s.previousSpan=r,s}function Jr(n){const e=new lt;return e.requests=n.usage.requests,e.inputTokens=n.usage.inputTokens,e.outputTokens=n.usage.outputTokens,e.totalTokens=n.usage.totalTokens,{usage:e,output:n.output.map(t=>Yn.parse(t)),responseId:n.responseId,providerData:n.providerData}}function Aa(n,e){switch(n.type){case"message_output_item":return new dn(n.rawItem,e.get(n.agent.name));case"tool_call_item":return new Me(n.rawItem,e.get(n.agent.name));case"tool_call_output_item":return new dt(n.rawItem,e.get(n.agent.name),n.output);case"reasoning_item":return new Xn(n.rawItem,e.get(n.agent.name));case"handoff_call_item":return new Qn(n.rawItem,e.get(n.agent.name));case"handoff_output_item":return new er(n.rawItem,e.get(n.sourceAgent.name),e.get(n.targetAgent.name));case"tool_approval_item":return new we(n.rawItem,e.get(n.agent.name))}}async function No(n,e,t){const r=await e.getAllTools(),s=new Map(r.filter(c=>c.type==="function").map(c=>[c.name,c])),a=new Map(r.filter(c=>c.type==="computer").map(c=>[c.name,c])),o=new Map(e.handoffs.map(c=>c instanceof pt?[c.name,da(c)]:[c.toolName,c])),i={newItems:t.newItems.map(c=>Aa(c,n)),toolsUsed:t.toolsUsed,handoffs:t.handoffs.map(c=>{if(!o.has(c.handoff.toolName))throw new F(`Handoff ${c.handoff.toolName} not found`);return{toolCall:c.toolCall,handoff:o.get(c.handoff.toolName)}}),functions:await Promise.all(t.functions.map(async c=>{if(!s.has(c.tool.name))throw new F(`Tool ${c.tool.name} not found`);return{toolCall:c.toolCall,tool:s.get(c.tool.name)}})),computerActions:t.computerActions.map(c=>{const l=c.computer.name;if(!a.has(l))throw new F(`Computer tool ${l} not found`);return{toolCall:c.toolCall,computer:a.get(l)}}),mcpApprovalRequests:(t.mcpApprovalRequests??[]).map(c=>({requestItem:new we(c.requestItem.rawItem,e),mcpTool:c.mcpTool}))};return{...i,hasToolsOrApprovalsToRun(){return i.handoffs.length>0||i.functions.length>0||i.mcpApprovalRequests.length>0||i.computerActions.length>0}}}const Gr=10;function Br(n,e){return n?!1:e?!0:"enabled_without_data"}function un(n,e){const t=e.filter(r=>r.type!=="tool_approval_item").map(r=>r.rawItem);return typeof n=="string"&&(n=[{type:"message",role:"user",content:n}]),[...n,...t]}var K,Nn,$n,jn,Da,Pn;class $o extends Hs{constructor(t={}){super();A(this,K);m(this,"config");m(this,"inputGuardrailDefs");m(this,"outputGuardrailDefs");this.config={modelProvider:t.modelProvider??Xs(),model:t.model,modelSettings:t.modelSettings,handoffInputFilter:t.handoffInputFilter,inputGuardrails:t.inputGuardrails,outputGuardrails:t.outputGuardrails,tracingDisabled:t.tracingDisabled??!1,traceIncludeSensitiveData:t.traceIncludeSensitiveData??!0,workflowName:t.workflowName??"Agent workflow",traceId:t.traceId,groupId:t.groupId,traceMetadata:t.traceMetadata},this.inputGuardrailDefs=(t.inputGuardrails??[]).map(Or),this.outputGuardrailDefs=(t.outputGuardrails??[]).map(Er)}run(t,r,s={stream:!1,context:void 0}){return r instanceof Ee&&r._trace?Is(r._trace,async()=>(r._currentAgentSpan&&We(r._currentAgentSpan),s!=null&&s.stream?U(this,K,Pn).call(this,t,r,s):U(this,K,Nn).call(this,t,r,s))):As(async()=>s!=null&&s.stream?U(this,K,Pn).call(this,t,r,s):U(this,K,Nn).call(this,t,r,s),{traceId:this.config.traceId,name:this.config.workflowName,groupId:this.config.groupId,metadata:this.config.traceMetadata})}}K=new WeakSet,Nn=async function(t,r,s){return Dn(async()=>{var o,i;const a=r instanceof Ee?r:new Ee(s.context instanceof gt?s.context:new gt(s.context),r,t,s.maxTurns??Gr);try{for(;;){let c=Vr(a._currentAgent.model,this.config.model);if(typeof c=="string"&&(c=await this.config.modelProvider.getModel(c)),a._currentStep=a._currentStep??{type:"next_step_run_again"},a._currentStep.type==="next_step_interruption"){if(I.debug("Continuing from interruption"),!a._lastTurnResponse||!a._lastProcessedResponse)throw new F("No model response found in previous state",a);const l=await Pr(a._currentAgent,a._originalInput,a._generatedItems,a._lastTurnResponse,a._lastProcessedResponse,this,a);if(a._toolUseTracker.addToolUse(a._currentAgent,a._lastProcessedResponse.toolsUsed),a._originalInput=l.originalInput,a._generatedItems=l.generatedItems,a._currentStep=l.nextStep,l.nextStep.type==="next_step_interruption")return new vn(a);continue}if(a._currentStep.type==="next_step_run_again"){const l=[];if(a._currentAgent.handoffs&&l.push(...a._currentAgent.handoffs.map(Cr)),!a._currentAgentSpan){const L=l.map(z=>z.agentName);a._currentAgentSpan=Ir({data:{name:a._currentAgent.name,handoffs:L,output_type:a._currentAgent.outputSchemaName}}),a._currentAgentSpan.start(),We(a._currentAgentSpan)}const d=await a._currentAgent.getAllTools(),y=d.map(L=>Rr(L)),w=l.map(L=>Nr(L));if(a._currentAgentSpan&&(a._currentAgentSpan.spanData.tools=d.map(L=>L.name)),a._currentTurn++,a._currentTurn>a._maxTurns)throw(o=a._currentAgentSpan)==null||o.setError({message:"Max turns exceeded",data:{max_turns:a._maxTurns}}),new ir(`Max turns (${a._maxTurns}) exceeded`,a);I.debug(`Running agent ${a._currentAgent.name} (turn ${a._currentTurn})`),a._currentTurn===1&&await U(this,K,$n).call(this,a);const E=un(a._originalInput,a._generatedItems);a._noActiveAgentRun&&(a._currentAgent.emit("agent_start",a._context,a._currentAgent),this.emit("agent_start",a._context,a._currentAgent));let b={...this.config.modelSettings,...a._currentAgent.modelSettings};b=jr(a._currentAgent,a._toolUseTracker,b),a._lastTurnResponse=await c.getResponse({systemInstructions:await a._currentAgent.getSystemPrompt(a._context),prompt:await a._currentAgent.getPrompt(a._context),input:E,previousResponseId:s.previousResponseId,modelSettings:b,tools:y,outputType:dr(a._currentAgent.outputType),handoffs:w,tracing:Br(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:s.signal}),a._modelResponses.push(a._lastTurnResponse),a._context.usage.add(a._lastTurnResponse.usage),a._noActiveAgentRun=!1;const v=$r(a._lastTurnResponse,a._currentAgent,d,l);a._lastProcessedResponse=v;const N=await Mr(a._currentAgent,a._originalInput,a._generatedItems,a._lastTurnResponse,a._lastProcessedResponse,this,a);a._toolUseTracker.addToolUse(a._currentAgent,a._lastProcessedResponse.toolsUsed),a._originalInput=N.originalInput,a._generatedItems=N.generatedItems,a._currentStep=N.nextStep}if(a._currentStep&&a._currentStep.type==="next_step_final_output")return await U(this,K,jn).call(this,a,a._currentStep.output),this.emit("agent_end",a._context,a._currentAgent,a._currentStep.output),a._currentAgent.emit("agent_end",a._context,a._currentStep.output),new vn(a);if(a._currentStep&&a._currentStep.type==="next_step_handoff")a._currentAgent=a._currentStep.newAgent,a._currentAgentSpan&&(a._currentAgentSpan.end(),Ce(),a._currentAgentSpan=void 0),a._noActiveAgentRun=!0,a._currentStep={type:"next_step_run_again"};else{if(a._currentStep&&a._currentStep.type==="next_step_interruption")return new vn(a);I.debug("Running next loop")}}}catch(c){throw a._currentAgentSpan&&a._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(c)}}),c}finally{a._currentAgentSpan&&(((i=a._currentStep)==null?void 0:i.type)!=="next_step_interruption"&&a._currentAgentSpan.end(),Ce())}})},$n=async function(t){const r=this.inputGuardrailDefs.concat(t._currentAgent.inputGuardrails.map(Or));if(r.length>0){const s={agent:t._currentAgent,input:t._originalInput,context:t._context};try{const a=await Promise.all(r.map(async o=>Dr(async i=>{const c=await o.run(s);return i.spanData.triggered=c.output.tripwireTriggered,c},{data:{name:o.name}},t._currentAgentSpan)));for(const o of a)if(o.output.tripwireTriggered)throw t._currentAgentSpan&&t._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:o.guardrail.name}}),new cr(`Input guardrail triggered: ${JSON.stringify(o.output.outputInfo)}`,o,t)}catch(a){throw a instanceof cr?a:(t._currentTurn--,new ur(`Input guardrail failed to complete: ${a}`,a,t))}}},jn=async function(t,r){const s=this.outputGuardrailDefs.concat(t._currentAgent.outputGuardrails.map(Er));if(s.length>0){const a=t._currentAgent.processFinalOutput(r),o={agent:t._currentAgent,agentOutput:a,context:t._context,details:{modelResponse:t._lastTurnResponse}};try{const i=await Promise.all(s.map(async c=>Dr(async l=>{const d=await c.run(o);return l.spanData.triggered=d.output.tripwireTriggered,d},{data:{name:c.name}},t._currentAgentSpan)));for(const c of i)if(c.output.tripwireTriggered)throw t._currentAgentSpan&&t._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:c.guardrail.name}}),new lr(`Output guardrail triggered: ${JSON.stringify(c.output.outputInfo)}`,c,t)}catch(i){throw i instanceof lr?i:new ur(`Output guardrail failed to complete: ${i}`,i,t)}}},Da=async function(t,r){var s,a,o;try{for(;;){const i=t.state._currentAgent,c=i.handoffs.map(Cr),l=await i.getAllTools(),d=l.map(w=>Rr(w)),y=c.map(w=>Nr(w));if(t.state._currentStep=t.state._currentStep??{type:"next_step_run_again"},t.state._currentStep.type==="next_step_interruption"){if(I.debug("Continuing from interruption"),!t.state._lastTurnResponse||!t.state._lastProcessedResponse)throw new F("No model response found in previous state",t.state);const w=await Pr(t.state._currentAgent,t.state._originalInput,t.state._generatedItems,t.state._lastTurnResponse,t.state._lastProcessedResponse,this,t.state);if(Lr(t,w),t.state._toolUseTracker.addToolUse(t.state._currentAgent,t.state._lastProcessedResponse.toolsUsed),t.state._originalInput=w.originalInput,t.state._generatedItems=w.generatedItems,t.state._currentStep=w.nextStep,w.nextStep.type==="next_step_interruption")return;continue}if(t.state._currentStep.type==="next_step_run_again"){if(!t.state._currentAgentSpan){const z=c.map(X=>X.agentName);t.state._currentAgentSpan=Ir({data:{name:i.name,handoffs:z,tools:l.map(X=>X.name),output_type:i.outputSchemaName}}),t.state._currentAgentSpan.start(),We(t.state._currentAgentSpan)}if(t.state._currentTurn++,t.state._currentTurn>t.state._maxTurns)throw(s=t.state._currentAgentSpan)==null||s.setError({message:"Max turns exceeded",data:{max_turns:t.state._maxTurns}}),new ir(`Max turns (${t.state._maxTurns}) exceeded`,t.state);I.debug(`Running agent ${i.name} (turn ${t.state._currentTurn})`);let w=Vr(i.model,this.config.model);typeof w=="string"&&(w=await this.config.modelProvider.getModel(w)),t.state._currentTurn===1&&await U(this,K,$n).call(this,t.state);let E={...this.config.modelSettings,...i.modelSettings};E=jr(i,t.state._toolUseTracker,E);const b=un(t.input,t.newItems);t.state._noActiveAgentRun&&(i.emit("agent_start",t.state._context,i),this.emit("agent_start",t.state._context,i));let v;for await(const z of w.getStreamedResponse({systemInstructions:await i.getSystemPrompt(t.state._context),prompt:await i.getPrompt(t.state._context),input:b,previousResponseId:r.previousResponseId,modelSettings:E,tools:d,handoffs:y,outputType:dr(i.outputType),tracing:Br(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:r.signal})){if(z.type==="response_done"){const X=ga.parse(z);v={usage:new lt(X.response.usage),output:X.response.output,responseId:X.response.id}}if(t.cancelled)return;t._addItem(new vo(z))}if(t.state._noActiveAgentRun=!1,!v)throw new ge("Model did not produce a final response!",t.state);t.state._lastTurnResponse=v,t.state._modelResponses.push(t.state._lastTurnResponse);const N=$r(t.state._lastTurnResponse,i,l,c);t.state._lastProcessedResponse=N;const L=await Mr(i,t.state._originalInput,t.state._generatedItems,t.state._lastTurnResponse,t.state._lastProcessedResponse,this,t.state);Lr(t,L),t.state._toolUseTracker.addToolUse(i,N.toolsUsed),t.state._originalInput=L.originalInput,t.state._generatedItems=L.generatedItems,t.state._currentStep=L.nextStep}if(t.state._currentStep.type==="next_step_final_output"){await U(this,K,jn).call(this,t.state,t.state._currentStep.output);return}else{if(t.state._currentStep.type==="next_step_interruption")return;t.state._currentStep.type==="next_step_handoff"?(t.state._currentAgent=(a=t.state._currentStep)==null?void 0:a.newAgent,t.state._currentAgentSpan&&(t.state._currentAgentSpan.end(),Ce()),t.state._currentAgentSpan=void 0,t._addItem(new xo(t.state._currentAgent)),t.state._noActiveAgentRun=!0,t.state._currentStep={type:"next_step_run_again"}):I.debug("Running next loop")}}}catch(i){throw t.state._currentAgentSpan&&t.state._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(i)}}),i}finally{t.state._currentAgentSpan&&(((o=t.state._currentStep)==null?void 0:o.type)!=="next_step_interruption"&&t.state._currentAgentSpan.end(),Ce())}},Pn=async function(t,r,s){return s=s??{},Dn(async()=>{const a=r instanceof Ee?r:new Ee(s.context instanceof gt?s.context:new gt(s.context),r,t,s.maxTurns??Gr),o=new go({signal:s.signal,state:a});return o.maxTurns=s.maxTurns??a._maxTurns,U(this,K,Da).call(this,o,s).then(()=>{o._done()},i=>{o._raiseError(i)}),o})};function Vr(n,e){return typeof n=="string"&&n!==pt.DEFAULT_MODEL_PLACEHOLDER||n?n:e??n??pt.DEFAULT_MODEL_PLACEHOLDER}const qe=class qe extends zs{constructor(t){super();m(this,"name");m(this,"instructions");m(this,"prompt");m(this,"handoffDescription");m(this,"handoffs");m(this,"model");m(this,"modelSettings");m(this,"tools");m(this,"mcpServers");m(this,"inputGuardrails");m(this,"outputGuardrails");m(this,"outputType","text");m(this,"toolUseBehavior");m(this,"resetToolChoice");if(typeof t.name!="string"||t.name.trim()==="")throw new F("Agent must have a name.");if(this.name=t.name,this.instructions=t.instructions??qe.DEFAULT_MODEL_PLACEHOLDER,this.prompt=t.prompt,this.handoffDescription=t.handoffDescription??"",this.handoffs=t.handoffs??[],this.model=t.model??"",this.modelSettings=t.modelSettings??{},this.tools=t.tools??[],this.mcpServers=t.mcpServers??[],this.inputGuardrails=t.inputGuardrails??[],this.outputGuardrails=t.outputGuardrails??[],t.outputType&&(this.outputType=t.outputType),this.toolUseBehavior=t.toolUseBehavior??"run_llm_again",this.resetToolChoice=t.resetToolChoice??!0,(t.handoffOutputTypeWarningEnabled===void 0||t.handoffOutputTypeWarningEnabled)&&this.handoffs&&this.outputType){const r=new Set([JSON.stringify(this.outputType)]);for(const s of this.handoffs)"outputType"in s&&s.outputType?r.add(JSON.stringify(s.outputType)):"agent"in s&&s.agent.outputType&&r.add(JSON.stringify(s.agent.outputType));r.size>1&&I.warn(`[Agent] Warning: Handoff agents have different output types: ${Array.from(r).join(", ")}. You can make it type-safe by using Agent.create({ ... }) method instead.`)}}static create(t){return new qe({...t,handoffs:t.handoffs,outputType:t.outputType,handoffOutputTypeWarningEnabled:!1})}get outputSchemaName(){if(this.outputType==="text")return"text";if(ot(this.outputType))return"ZodOutput";if(typeof this.outputType=="object")return this.outputType.name;throw new Error(`Unknown output type: ${this.outputType}`)}clone(t){return new qe({...this,...t})}asTool(t){const{toolName:r,toolDescription:s,customOutputExtractor:a}=t;return wn({name:r??qt(this.name),description:s??"",parameters:{type:"object",properties:{input:{type:"string"}},required:["input"],additionalProperties:!1},strict:!0,execute:async(o,i)=>{if(!Ua(o))throw new ge("Agent tool called with invalid input");const l=await new $o().run(this,o.input,{context:i==null?void 0:i.context});return typeof a=="function"?a(l):yo(l.rawResponses[l.rawResponses.length-1])}})}async getSystemPrompt(t){return typeof this.instructions=="function"?await this.instructions(t,this):this.instructions}async getPrompt(t){return typeof this.prompt=="function"?await this.prompt(t,this):this.prompt}async getMcpTools(){return this.mcpServers.length>0?ys(this.mcpServers):[]}async getAllTools(){return[...await this.getMcpTools(),...this.tools]}processFinalOutput(t){if(this.outputType==="text")return t;if(typeof this.outputType=="object"){const r=JSON.parse(t);return ot(this.outputType)?this.outputType.parse(r):r}throw new Error(`Unknown output type: ${this.outputType}`)}toJSON(){return{name:this.name}}};m(qe,"DEFAULT_MODEL_PLACEHOLDER","");let pt=qe;Bs(aa());const jo={version:"0.0.13"},Po="responses",Mo="gpt-4.1";let Lo=Po;function Uo(){return zn().OPENAI_API_KEY}function Zo(){return Lo==="responses"}function Fo(){return zn().OPENAI_API_KEY}const tr={"User-Agent":`Agents/JavaScript ${jo.version}`},B=Gn("openai-agents:openai"),Jo=J(["in_progress","completed","searching","failed"]).default("failed"),Go=J(["in_progress","completed","searching","failed","incomplete"]).default("failed"),Bo=J(["in_progress","completed","interpreting"]).default("in_progress"),Vo=J(["in_progress","completed","generating","failed"]).default("failed");function Z(n){if(!n||typeof n!="object"||Array.isArray(n))return n;const e={};for(const[t,r]of Object.entries(n)){const s=t.replace(/([A-Z])/g,"_$1").toLowerCase();e[s]=Z(r)}return e}const zo=J(["file_search","web_search_preview","computer_use_preview","code_interpreter","image_generation","mcp"]),Ho=J(["auto","required","none"]);function qo(n){if(typeof n>"u")return;const e=Ho.safeParse(n);if(e.success)return e.data;const t=zo.safeParse(n);return t.success?{type:t.data}:{type:"function",name:n}}function Wo(n){if(n!=="text")return{format:n}}function Ko(n,e){const t=[],r=[];for(const s of n){const{tool:a,include:o}=Yo(s);if(t.push(a),o&&o.length>0)for(const i of o)r.push(i)}return{tools:[...t,...e.map(Qo)],include:r}}function Yo(n){var e,t,r,s,a;if(n.type==="function")return{tool:{type:"function",name:n.name,description:n.description,parameters:n.parameters,strict:n.strict},include:void 0};if(n.type==="computer")return{tool:{type:"computer_use_preview",environment:n.environment,display_width:n.dimensions[0],display_height:n.dimensions[1]},include:void 0};if(n.type==="hosted_tool"){if(((e=n.providerData)==null?void 0:e.type)==="web_search")return{tool:{type:"web_search_preview",user_location:n.providerData.user_location,search_context_size:n.providerData.search_context_size},include:void 0};if(((t=n.providerData)==null?void 0:t.type)==="file_search")return{tool:{type:"file_search",vector_store_ids:n.providerData.vector_store_ids||(typeof n.providerData.vector_store_id=="string"?[n.providerData.vector_store_id]:n.providerData.vector_store_id),max_num_results:n.providerData.max_num_results,ranking_options:n.providerData.ranking_options,filters:n.providerData.filters},include:n.providerData.include_search_results?["file_search_call.results"]:void 0};if(((r=n.providerData)==null?void 0:r.type)==="code_interpreter")return{tool:{type:"code_interpreter",container:n.providerData.container},include:void 0};if(((s=n.providerData)==null?void 0:s.type)==="image_generation")return{tool:{type:"image_generation",background:n.providerData.background,input_fidelity:n.providerData.input_fidelity,input_image_mask:n.providerData.input_image_mask,model:n.providerData.model,moderation:n.providerData.moderation,output_compression:n.providerData.output_compression,output_format:n.providerData.output_format,partial_images:n.providerData.partial_images,quality:n.providerData.quality,size:n.providerData.size},include:void 0};if(((a=n.providerData)==null?void 0:a.type)==="mcp")return{tool:{type:"mcp",server_label:n.providerData.server_label,server_url:n.providerData.server_url,allowed_tools:n.providerData.allowed_tools,headers:n.providerData.headers,require_approval:Xo(n.providerData.require_approval)},include:void 0};if(n.providerData)return{tool:n.providerData,include:void 0}}throw new Error(`Unsupported tool type: ${JSON.stringify(n)}`)}function Xo(n){var e,t;return n==="never"||n===void 0?"never":n==="always"?"always":{never:{tool_names:(e=n.never)==null?void 0:e.tool_names},always:{tool_names:(t=n.always)==null?void 0:t.tool_names}}}function Qo(n){return{name:n.toolName,description:n.toolDescription,parameters:n.inputJsonSchema,strict:n.strictJsonSchema,type:"function"}}function Oa(n){if(n.type==="input_text")return{type:"input_text",text:n.text,...Z(n.providerData)};if(n.type==="input_image"){const e={type:"input_image",detail:"auto"};return typeof n.image=="string"?e.image_url=n.image:e.file_id=n.image.id,{...e,...Z(n.providerData)}}else if(n.type==="input_file"){const e={type:"input_file"};if(typeof n.file=="string")if(n.file.startsWith("data:"))e.file_data=n.file;else if(n.file.startsWith("https://"))e.file_url=n.file;else throw new F("Unsupported string data for file input. If you're trying to pass an uploaded file's ID, use an object with the ID property instead.");else"id"in n.file?e.file_id=n.file.id:"url"in n.file&&(e.file_url=n.file.url);return{...e,...Z(n.providerData)}}throw new F(`Unsupported input content type: ${JSON.stringify(n)}`)}function ei(n){if(n.type==="output_text")return{type:"output_text",text:n.text,annotations:[],...Z(n.providerData)};if(n.type==="refusal")return{type:"refusal",refusal:n.refusal,...Z(n.providerData)};throw new F(`Unsupported output content type: ${JSON.stringify(n)}`)}function ti(n){if(n.role==="system")return{id:n.id,role:"system",content:n.content,...Z(n.providerData)};if(n.role==="user")return typeof n.content=="string"?{id:n.id,role:"user",content:n.content,...Z(n.providerData)}:{id:n.id,role:"user",content:n.content.map(Oa),...Z(n.providerData)};if(n.role==="assistant")return{type:"message",id:n.id,role:"assistant",content:n.content.map(ei),status:n.status,...Z(n.providerData)};throw new F(`Unsupported item ${JSON.stringify(n)}`)}function ni(n){return n.type==="message"||typeof n.type>"u"&&typeof n.role=="string"}function ri(n){if(!n)return;const e={};for(const[t,r]of Object.entries(n.variables??{}))typeof r=="string"?e[t]=r:typeof r=="object"&&(e[t]=Oa(r));return{id:n.promptId,version:n.version,variables:e}}function ai(n){return typeof n=="string"?[{role:"user",content:n}]:n.map(e=>{var r,s,a,o,i,c,l,d,y,w,E,b,v,N,L,z,X,Be,ht,mt,ar,sr;if(ni(e))return ti(e);if(e.type==="function_call")return{id:e.id,type:"function_call",name:e.name,call_id:e.callId,arguments:e.arguments,status:e.status,...Z(e.providerData)};if(e.type==="function_call_result"){if(e.output.type!=="text")throw new F(`Unsupported tool result type: ${JSON.stringify(e.output)}`);return{type:"function_call_output",id:e.id,call_id:e.callId,output:e.output.text,status:e.status,...Z(e.providerData)}}if(e.type==="reasoning")return{id:e.id,type:"reasoning",summary:e.content.map(Ve=>({type:"summary_text",text:Ve.text,...Z(Ve.providerData)})),encrypted_content:(r=e.providerData)==null?void 0:r.encryptedContent,...Z(e.providerData)};if(e.type==="computer_call")return{type:"computer_call",call_id:e.callId,id:e.id,action:e.action,status:e.status,pending_safety_checks:[],...Z(e.providerData)};if(e.type==="computer_call_result")return{type:"computer_call_output",id:e.id,call_id:e.callId,output:si(e),status:(s=e.providerData)==null?void 0:s.status,acknowledged_safety_checks:(a=e.providerData)==null?void 0:a.acknowledgedSafetyChecks,...Z(e.providerData)};if(e.type==="hosted_tool_call"){if(((o=e.providerData)==null?void 0:o.type)==="web_search_call"||((i=e.providerData)==null?void 0:i.type)==="web_search")return{...Z(e.providerData),type:"web_search_call",id:e.id,status:Jo.parse(e.status??"failed")};if(((c=e.providerData)==null?void 0:c.type)==="file_search_call"||((l=e.providerData)==null?void 0:l.type)==="file_search")return{...Z(e.providerData),type:"file_search_call",id:e.id,status:Go.parse(e.status??"failed"),queries:((d=e.providerData)==null?void 0:d.queries)??[],results:(y=e.providerData)==null?void 0:y.results};if(((w=e.providerData)==null?void 0:w.type)==="code_interpreter_call"||((E=e.providerData)==null?void 0:E.type)==="code_interpreter")return{...Z(e.providerData),type:"code_interpreter_call",id:e.id,code:((b=e.providerData)==null?void 0:b.code)??"",outputs:((v=e.providerData)==null?void 0:v.outputs)??((N=e.providerData)==null?void 0:N.results)??[],status:Bo.parse(e.status??"failed"),container_id:(L=e.providerData)==null?void 0:L.containerId};if(((z=e.providerData)==null?void 0:z.type)==="image_generation_call"||((X=e.providerData)==null?void 0:X.type)==="image_generation")return{...Z(e.providerData),type:"image_generation_call",id:e.id,result:((Be=e.providerData)==null?void 0:Be.result)??null,status:Vo.parse(e.status??"failed")};if(((ht=e.providerData)==null?void 0:ht.type)==="mcp_list_tools"||e.name==="mcp_list_tools"){const M=e.providerData;return{...Z(e.providerData),type:"mcp_list_tools",id:e.id,tools:Z(M.tools),server_label:M.server_label,error:M.error}}else if(((mt=e.providerData)==null?void 0:mt.type)==="mcp_approval_request"||e.name==="mcp_approval_request"){const M=e.providerData;return{...Z(e.providerData),type:"mcp_approval_request",id:M.id??e.id,name:M.name,arguments:M.arguments,server_label:M.server_label}}else if(((ar=e.providerData)==null?void 0:ar.type)==="mcp_approval_response"||e.name==="mcp_approval_response"){const M=e.providerData;return{...Z(M),type:"mcp_approval_response",id:M.id,approve:M.approve,approval_request_id:M.approval_request_id,reason:M.reason}}else if(((sr=e.providerData)==null?void 0:sr.type)==="mcp_call"||e.name==="mcp_call"){const M=e.providerData;return{...Z(M),type:"mcp_call",id:M.id??e.id,name:M.name,arguments:M.arguments,server_label:M.server_label,error:M.error}}throw new F(`Unsupported built-in tool call type: ${JSON.stringify(e)}`)}if(e.type==="unknown")return{...Z(e.providerData),id:e.id};const t=e;throw new F(`Unsupported item ${JSON.stringify(t)}`)})}function si(n){return{type:"computer_screenshot",image_url:n.output.data}}function oi(n){if(n.type==="output_text"){const{type:e,text:t,...r}=n;return{type:e,text:t,...r}}if(n.type==="refusal"){const{type:e,refusal:t,...r}=n;return{type:e,refusal:t,...r}}throw new Error(`Unsupported message content type: ${JSON.stringify(n)}`)}function zr(n){return n.map(e=>{if(e.type==="message"){const{id:t,type:r,role:s,content:a,status:o,...i}=e;return{id:t,type:r,role:s,content:a.map(oi),status:o,providerData:i}}else if(e.type==="file_search_call"||e.type==="web_search_call"||e.type==="image_generation_call"||e.type==="code_interpreter_call"){const{status:t,...r}=e;let s;return"result"in r&&r.result!==null&&(s=r.result,delete r.result),{type:"hosted_tool_call",id:e.id,name:e.type,status:t,output:s,providerData:r}}else if(e.type==="function_call"){const{call_id:t,name:r,status:s,arguments:a,...o}=e;return{type:"function_call",id:e.id,callId:t,name:r,status:s,arguments:a,providerData:o}}else if(e.type==="computer_call"){const{call_id:t,status:r,action:s,...a}=e;return{type:"computer_call",id:e.id,callId:t,status:r,action:s,providerData:a}}else if(e.type==="mcp_list_tools"){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:void 0,providerData:t}}else if(e.type==="mcp_approval_request"){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:"mcp_approval_request",status:"completed",output:void 0,providerData:t}}else if(e.type==="mcp_call"){const{output:t,...r}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:t||void 0,providerData:r}}else if(e.type==="reasoning"){const{summary:t,...r}=e;return{type:"reasoning",id:e.id,content:t.map(a=>{const{text:o,...i}=a;return{type:"input_text",text:o,providerData:i}}),providerData:r}}return{type:"unknown",providerData:e}})}var Ut,Zt,Ft,Mn;class ii{constructor(e,t){A(this,Ft);A(this,Ut);A(this,Zt);k(this,Ut,e),k(this,Zt,t)}async getResponse(e){var s,a,o,i,c;const t=await Ps(async l=>{const d=await U(this,Ft,Mn).call(this,e,!1);return e.tracing&&(l.spanData.response_id=d.id,l.spanData._input=e.input,l.spanData._response=d),d});return{usage:new lt({inputTokens:((s=t.usage)==null?void 0:s.input_tokens)??0,outputTokens:((a=t.usage)==null?void 0:a.output_tokens)??0,totalTokens:((o=t.usage)==null?void 0:o.total_tokens)??0,inputTokensDetails:{...(i=t.usage)==null?void 0:i.input_tokens_details},outputTokensDetails:{...(c=t.usage)==null?void 0:c.output_tokens_details}}),output:zr(t.output),responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?ia():void 0;try{t&&(t.start(),We(t),e.tracing===!0&&(t.spanData._input=e.input));const r=await U(this,Ft,Mn).call(this,e,!0);let s;for await(const a of r){if(a.type==="response.created")yield{type:"response_started",providerData:{...a}};else if(a.type==="response.completed"){s=a.response;const{response:o,...i}=a,{output:c,usage:l,id:d,...y}=o;yield{type:"response_done",response:{id:d,output:zr(c),usage:{inputTokens:(l==null?void 0:l.input_tokens)??0,outputTokens:(l==null?void 0:l.output_tokens)??0,totalTokens:(l==null?void 0:l.total_tokens)??0,inputTokensDetails:{...l==null?void 0:l.input_tokens_details},outputTokensDetails:{...l==null?void 0:l.output_tokens_details}},providerData:y},providerData:i},yield{type:"model",event:a}}else if(a.type==="response.output_text.delta"){const{delta:o,...i}=a;yield{type:"output_text_delta",delta:o,providerData:i}}yield{type:"model",event:a}}e.tracing&&t&&s&&(t.spanData.response_id=s.id,t.spanData._response=s)}catch(r){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing?String(r):r instanceof Error?r.name:void 0}}),r}finally{t&&(t.end(),Ce())}}}Ut=new WeakMap,Zt=new WeakMap,Ft=new WeakSet,Mn=async function(e,t){const r=ai(e.input),{tools:s,include:a}=Ko(e.tools,e.handoffs),o=qo(e.modelSettings.toolChoice),i=Wo(e.outputType),c=ri(e.prompt);let l;if(typeof e.modelSettings.parallelToolCalls=="boolean"){if(e.modelSettings.parallelToolCalls&&s.length===0)throw new Error("Parallel tool calls are not supported without tools");l=e.modelSettings.parallelToolCalls}const d={instructions:e.systemInstructions,model:p(this,Zt),input:r,include:a,tools:s,previous_response_id:e.previousResponseId,prompt:c,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,truncation:e.modelSettings.truncation,max_output_tokens:e.modelSettings.maxTokens,tool_choice:o,parallel_tool_calls:l,stream:t,text:i,store:e.modelSettings.store,...e.modelSettings.providerData};B.dontLogModelData?B.debug("Calling LLM"):B.debug(`Calling LLM. Request data: ${JSON.stringify(d,null,2)}`);const y=await p(this,Ut).responses.create(d,{headers:tr,signal:e.signal});return B.dontLogModelData?B.debug("Response received"):B.debug(`Response received: ${JSON.stringify(y,null,2)}`),y};async function*ui(n,e){var o,i,c,l;let t;const r={started:!1,text_content_index_and_output:null,refusal_content_index_and_output:null,function_calls:{}};for await(const d of e){if(r.started||(r.started=!0,yield{type:"response_started",providerData:{...d}}),yield{type:"model",event:d},t=d.usage||void 0,!((i=(o=d.choices)==null?void 0:o[0])!=null&&i.delta))continue;const y=d.choices[0].delta;if(y.content&&(r.text_content_index_and_output||(r.text_content_index_and_output=[r.refusal_content_index_and_output?1:0,{text:"",type:"output_text",providerData:{annotations:[]}}]),yield{type:"output_text_delta",delta:y.content,providerData:{...d}},r.text_content_index_and_output[1].text+=y.content),"refusal"in y&&y.refusal&&(r.refusal_content_index_and_output||(r.refusal_content_index_and_output=[r.text_content_index_and_output?1:0,{refusal:"",type:"refusal"}]),r.refusal_content_index_and_output[1].refusal+=y.refusal),y.tool_calls)for(const w of y.tool_calls){w.index in r.function_calls||(r.function_calls[w.index]={id:Ln,arguments:"",name:"",type:"function_call",callId:""});const E=w.function;r.function_calls[w.index].arguments+=(E==null?void 0:E.arguments)||"",r.function_calls[w.index].name+=(E==null?void 0:E.name)||"",r.function_calls[w.index].callId+=w.id||""}}const s=[];if(r.text_content_index_and_output||r.refusal_content_index_and_output){const d={id:Ln,content:[],role:"assistant",type:"message",status:"completed"};r.text_content_index_and_output&&d.content.push(r.text_content_index_and_output[1]),r.refusal_content_index_and_output&&d.content.push(r.refusal_content_index_and_output[1]),s.push(d)}for(const d of Object.values(r.function_calls))s.push(d);yield{type:"response_done",response:{id:n.id,usage:{inputTokens:(t==null?void 0:t.prompt_tokens)??0,outputTokens:(t==null?void 0:t.completion_tokens)??0,totalTokens:(t==null?void 0:t.total_tokens)??0,inputTokensDetails:{cached_tokens:((c=t==null?void 0:t.prompt_tokens_details)==null?void 0:c.cached_tokens)??0},outputTokensDetails:{reasoning_tokens:((l=t==null?void 0:t.completion_tokens_details)==null?void 0:l.reasoning_tokens)??0}},output:s}}}function ci(n){if(!(n==null||n==null))return n==="auto"||n==="required"||n==="none"?n:{type:"function",function:{name:n}}}function li(n){if(typeof n=="string")return n;const e=[];for(const t of n)if(t.type==="output_text"||t.type==="input_text")e.push({type:"text",text:t.text,...t.providerData});else if(t.type==="refusal")e.push({type:"refusal",refusal:t.refusal,...t.providerData});else{if(t.type==="audio"||t.type==="image")continue;{const r=t;throw new Error(`Unknown content: ${JSON.stringify(r)}`)}}return e}function di(n){if(typeof n=="string")return n;const e=[];for(const t of n)if(t.type==="input_text")e.push({type:"text",text:t.text,...t.providerData});else if(t.type==="input_image"){if(typeof t.image!="string")throw new Error(`Only image URLs are supported for input_image: ${JSON.stringify(t)}`);const{image_url:r,...s}=t.providerData||{};e.push({type:"image_url",image_url:{url:t.image,...r},...s})}else{if(t.type==="input_file")throw new Error(`File uploads are not supported for chat completions: ${JSON.stringify(t)}`);if(t.type==="audio"){const{input_audio:r,...s}=t.providerData||{};e.push({type:"input_audio",input_audio:{data:t.audio,...r},...s})}else{const r=t;throw new Error(`Unknown content: ${JSON.stringify(r)}`)}}return e}function pi(n){return n.type==="message"||typeof n.type>"u"&&typeof n.role=="string"}function fi(n){var a;if(typeof n=="string")return[{role:"user",content:n}];const e=[];let t=null;const r=()=>{t&&((!t.tool_calls||t.tool_calls.length===0)&&delete t.tool_calls,e.push(t),t=null)},s=()=>(t||(t={role:"assistant",tool_calls:[]}),t);for(const o of n)if(pi(o)){const{content:i,role:c,providerData:l}=o;if(r(),c==="assistant"){const d={role:"assistant",content:li(i),...l},y=i.find(w=>w.type==="audio");y&&(d.audio={id:"",...y.providerData}),e.push(d)}else c==="user"?e.push({role:c,content:di(i),...l}):c==="system"&&e.push({role:"system",content:i,...l})}else{if(o.type==="reasoning")throw new F("Reasoning is not supported for chat completions. Got item: "+JSON.stringify(o));if(o.type==="hosted_tool_call")if(o.name==="file_search_call"){const i=s(),c=i.tool_calls??[],l=o,{function:d,...y}=l.providerData??{},{arguments:w,...E}=d??{};c.push({id:l.id||"",type:"function",function:{name:"file_search_call",arguments:JSON.stringify({queries:((a=l.providerData)==null?void 0:a.queries)??[],status:l.status,...w}),...E},...y}),i.tool_calls=c;continue}else throw new F("Hosted tool calls are not supported for chat completions. Got item: "+JSON.stringify(o));else{if(o.type==="computer_call"||o.type==="computer_call_result")throw new F("Computer use calls are not supported for chat completions. Got item: "+JSON.stringify(o));if(o.type==="function_call"){const i=s(),c=i.tool_calls??[],l=o;c.push({id:l.callId,type:"function",function:{name:l.name,arguments:l.arguments??"{}"}}),i.tool_calls=c}else if(o.type==="function_call_result"){r();const i=o;if(i.output.type!=="text")throw new F("Only text output is supported for chat completions. Got item: "+JSON.stringify(o));e.push({role:"tool",tool_call_id:i.callId,content:i.output.text,...i.providerData})}else if(o.type==="unknown")e.push({...o.providerData});else{const i=o;throw new Error(`Unknown item type: ${JSON.stringify(i)}`)}}}return r(),e}function hi(n){if(n.type==="function")return{type:"function",function:{name:n.name,description:n.description||"",parameters:n.parameters}};throw new Error(`Hosted tools are not supported with the ChatCompletions API. Got tool type: ${n.type}, tool: ${JSON.stringify(n)}`)}function mi(n){return{type:"function",function:{name:n.toolName,description:n.toolDescription||"",parameters:n.inputJsonSchema}}}const Ln="FAKE_ID";var st,je,Jt,Un;class _i{constructor(e,t){A(this,Jt);A(this,st);A(this,je);k(this,st,e),k(this,je,t)}async getResponse(e){const t=await Zs(async a=>{a.spanData.model=p(this,je),a.spanData.model_config=e.modelSettings?{temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty}:{base_url:p(this,st).baseURL};const o=await U(this,Jt,Un).call(this,e,a,!1);return a&&e.tracing===!0&&(a.spanData.output=[o]),o}),r=[];if(t.choices&&t.choices[0]){const a=t.choices[0].message;if(a.content!==void 0&&a.content!==null&&!(a.tool_calls&&a.content==="")){const{content:o,...i}=a;r.push({id:t.id,type:"message",role:"assistant",content:[{type:"output_text",text:o||"",providerData:i}],status:"completed"})}else if(a.refusal){const{refusal:o,...i}=a;r.push({id:t.id,type:"message",role:"assistant",content:[{type:"refusal",refusal:o||"",providerData:i}],status:"completed"})}else if(a.audio){const{data:o,...i}=a.audio;r.push({id:t.id,type:"message",role:"assistant",content:[{type:"audio",audio:o,providerData:i}],status:"completed"})}else if(a.tool_calls)for(const o of a.tool_calls){const{id:i,...c}=o,{arguments:l,name:d,...y}=o.function;r.push({id:t.id,type:"function_call",arguments:l,name:d,callId:i,status:"completed",providerData:{...c,...y}})}}return{usage:t.usage?new lt(yi(t.usage)):new lt,output:r,responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?ua():void 0;try{t&&(t.start(),We(t));const r=await U(this,Jt,Un).call(this,e,t,!0),s={id:Ln,created:Math.floor(Date.now()/1e3),model:p(this,je),object:"chat.completion",choices:[],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}};for await(const a of ui(s,r))yield a;t&&s&&e.tracing===!0&&(t.spanData.output=[s])}catch(r){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing===!0?String(r):r instanceof Error?r.name:void 0}}),r}finally{t&&(t.end(),Ce())}}}st=new WeakMap,je=new WeakMap,Jt=new WeakSet,Un=async function(e,t,r){const s=[];if(e.tools)for(const d of e.tools)s.push(hi(d));if(e.handoffs)for(const d of e.handoffs)s.push(mi(d));const a=gi(e.outputType);let o;if(typeof e.modelSettings.parallelToolCalls=="boolean"){if(e.modelSettings.parallelToolCalls&&s.length===0)throw new Error("Parallel tool calls are not supported without tools");o=e.modelSettings.parallelToolCalls}const i=fi(e.input);e.systemInstructions&&i.unshift({content:e.systemInstructions,role:"system"}),t&&e.tracing===!0&&(t.spanData.input=i);const c={model:p(this,je),messages:i,tools:s.length?s:void 0,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty,max_tokens:e.modelSettings.maxTokens,tool_choice:ci(e.modelSettings.toolChoice),response_format:a,parallel_tool_calls:o,stream:r,store:e.modelSettings.store,...e.modelSettings.providerData};B.dontLogModelData?B.debug("Calling LLM"):B.debug(`Calling LLM. Request data: ${JSON.stringify(c,null,2)}`);const l=await p(this,st).chat.completions.create(c,{headers:tr,signal:e.signal});return B.dontLogModelData?B.debug("Response received"):B.debug(`Response received: ${JSON.stringify(l,null,2)}`),l};function gi(n){return n==="text"?{type:"text"}:n.type==="json_schema"?{type:"json_schema",json_schema:{name:n.name,strict:n.strict,schema:n.schema}}:{type:"json_object"}}function yi(n){var e,t;return{requests:1,input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens,input_tokens_details:{cached_tokens:((e=n.prompt_tokens_details)==null?void 0:e.cached_tokens)||0},output_tokens_details:{reasoning_tokens:((t=n.completion_tokens_details)==null?void 0:t.reasoning_tokens)||0}}}var Pe,Gt,ne,Bt,Zn;class vi{constructor(e={}){A(this,Bt);A(this,Pe);A(this,Gt);A(this,ne);if(k(this,ne,e),p(this,ne).openAIClient){if(p(this,ne).apiKey)throw new Error("Cannot provide both apiKey and openAIClient");if(p(this,ne).baseURL)throw new Error("Cannot provide both baseURL and openAIClient");k(this,Pe,p(this,ne).openAIClient)}k(this,Gt,p(this,ne).useResponses)}async getModel(e){const t=e||Mo;return p(this,Gt)??Zo()?new ii(U(this,Bt,Zn).call(this),t):new _i(U(this,Bt,Zn).call(this),t)}}Pe=new WeakMap,Gt=new WeakMap,ne=new WeakMap,Bt=new WeakSet,Zn=function(){return p(this,Pe)||k(this,Pe,new ja({apiKey:p(this,ne).apiKey??Fo(),baseURL:p(this,ne).baseURL,organization:p(this,ne).organization,project:p(this,ne).project})),p(this,Pe)};var ce;class wi{constructor(e={}){A(this,ce);k(this,ce,{apiKey:e.apiKey??void 0,organization:e.organization??"",project:e.project??"",endpoint:e.endpoint??"https://api.openai.com/v1/traces/ingest",maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4})}async export(e,t){const r=p(this,ce).apiKey??Uo();if(!r){B.error("No API key provided for OpenAI tracing exporter. Exports will be skipped");return}const s={data:e.map(i=>i.toJSON()).filter(i=>!!i)};let a=0,o=p(this,ce).baseDelay;for(;a<p(this,ce).maxRetries;){try{const c=await fetch(p(this,ce).endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`,"OpenAI-Beta":"traces=v1",...tr},body:JSON.stringify(s),signal:t});if(c.ok){B.debug(`Exported ${s.data.length} items`);return}if(c.status>=400&&c.status<500){B.error(`[non-fatal] Tracing client error ${c.status}: ${await c.text()}`);return}B.warn(`[non-fatal] Tracing: server error ${c.status}, retrying.`)}catch(c){B.error("[non-fatal] Tracing: request failed: ",c)}if(t!=null&&t.aborted){B.error("Tracing: request aborted");return}const i=o+Math.random()*.1*o;await new Promise(c=>setTimeout(c,i)),o=Math.min(o*2,p(this,ce).maxDelay),a++}B.error(`Tracing: failed to export traces after ${p(this,ce).maxRetries} attempts`)}}ce=new WeakMap;function xi(){const n=new wi,e=new ra(n);Vs([e])}Gn("openai-agents:realtime");h({itemId:u()});re("role",[h({itemId:u(),previousItemId:u().nullable().optional(),type:f("message"),role:f("system"),content:P(h({type:f("input_text"),text:u()}))}),h({itemId:u(),previousItemId:u().nullable().optional(),type:f("message"),role:f("user"),status:J(["in_progress","completed"]),content:P(h({type:f("input_text"),text:u()}).or(h({type:f("input_audio"),audio:u().nullable().optional(),transcript:u().nullable()})))}),h({itemId:u(),previousItemId:u().nullable().optional(),type:f("message"),role:f("assistant"),status:J(["in_progress","completed","incomplete"]),content:P(h({type:f("text"),text:u()}).or(h({type:f("audio"),audio:u().nullable().optional(),transcript:u().nullable().optional()})))})]);h({itemId:u(),previousItemId:u().nullable().optional(),type:f("function_call"),status:J(["in_progress","completed"]),arguments:u(),name:u(),output:u().nullable()});const Ea=h({id:u().optional().nullable(),conversation_id:u().optional().nullable(),max_output_tokens:T().or(f("inf")).optional().nullable(),metadata:V(u(),$()).optional().nullable(),modalities:P(u()).optional().nullable(),object:f("realtime.response").optional().nullable(),output:P($()).optional().nullable(),output_audio_format:u().optional().nullable(),status:J(["completed","incomplete","failed","cancelled","in_progress"]).optional().nullable(),status_details:V(u(),$()).optional().nullable(),usage:h({input_tokens:T().optional(),input_tokens_details:V(u(),$()).optional().nullable(),output_tokens:T().optional(),output_tokens_details:V(u(),$()).optional().nullable()}).optional().nullable(),voice:u().optional().nullable()}),Si=h({id:u().optional(),audio:u().nullable().optional(),text:u().nullable().optional(),transcript:u().nullable().optional(),type:Qr([f("input_text"),f("input_audio"),f("item_reference"),f("text"),f("audio")])}),Vt=h({id:u().optional(),arguments:u().optional(),call_id:u().optional(),content:P(Si).optional(),name:u().optional(),object:f("realtime.item").optional(),output:u().optional(),role:J(["user","assistant","system"]).optional(),status:J(["completed","incomplete","in_progress"]).optional(),type:J(["message","function_call","function_call_output"]).optional()}),Ti=h({type:f("conversation.created"),event_id:u(),conversation:h({id:u().optional(),object:f("realtime.conversation").optional()})}),bi=h({type:f("conversation.item.created"),event_id:u(),item:Vt,previous_item_id:u().nullable().optional()}),ki=h({type:f("conversation.item.deleted"),event_id:u(),item_id:u()}),Ii=h({type:f("conversation.item.input_audio_transcription.completed"),event_id:u(),item_id:u(),content_index:T(),transcript:u(),logprobs:P($()).nullable().optional()}),Ai=h({type:f("conversation.item.input_audio_transcription.delta"),event_id:u(),item_id:u(),content_index:T().optional(),delta:u().optional(),logprobs:P($()).nullable().optional()}),Di=h({type:f("conversation.item.input_audio_transcription.failed"),event_id:u(),item_id:u(),content_index:T(),error:h({code:u().optional(),message:u().optional(),param:u().optional(),type:u().optional()})}),Oi=h({type:f("conversation.item.retrieved"),event_id:u(),item:Vt}),Ei=h({type:f("conversation.item.truncated"),event_id:u(),item_id:u(),audio_end_ms:T(),content_index:T()}),Ci=h({type:f("conversation.item.create"),item:Vt,event_id:u().optional(),previous_item_id:u().nullable().optional()}),Ri=h({type:f("conversation.item.delete"),item_id:u(),event_id:u().optional()}),Ni=h({type:f("conversation.item.retrieve"),item_id:u(),event_id:u().optional()}),$i=h({type:f("conversation.item.truncate"),item_id:u(),audio_end_ms:T(),content_index:T(),event_id:u().optional()}),ji=h({type:f("error"),event_id:u().optional(),error:$().optional()}),Pi=h({type:f("input_audio_buffer.cleared"),event_id:u()}),Mi=h({type:f("input_audio_buffer.append"),audio:u(),event_id:u().optional()}),Li=h({type:f("input_audio_buffer.clear"),event_id:u().optional()}),Ui=h({type:f("input_audio_buffer.commit"),event_id:u().optional()}),Zi=h({type:f("input_audio_buffer.committed"),event_id:u(),item_id:u(),previous_item_id:u().nullable().optional()}),Fi=h({type:f("input_audio_buffer.speech_started"),event_id:u(),item_id:u(),audio_start_ms:T()}),Ji=h({type:f("input_audio_buffer.speech_stopped"),event_id:u(),item_id:u(),audio_end_ms:T()}),Gi=h({type:f("output_audio_buffer.started"),event_id:u()}).passthrough(),Bi=h({type:f("output_audio_buffer.stopped"),event_id:u()}).passthrough(),Vi=h({type:f("output_audio_buffer.cleared"),event_id:u()}),zi=h({type:f("rate_limits.updated"),event_id:u(),rate_limits:P(h({limit:T().optional(),name:J(["requests","tokens"]).optional(),remaining:T().optional(),reset_seconds:T().optional()}))}),Hi=h({type:f("response.audio.delta"),event_id:u(),item_id:u(),content_index:T(),delta:u(),output_index:T(),response_id:u()}),qi=h({type:f("response.audio.done"),event_id:u(),item_id:u(),content_index:T(),output_index:T(),response_id:u()}),Wi=h({type:f("response.audio_transcript.delta"),event_id:u(),item_id:u(),content_index:T(),delta:u(),output_index:T(),response_id:u()}),Ki=h({type:f("response.audio_transcript.done"),event_id:u(),item_id:u(),content_index:T(),transcript:u(),output_index:T(),response_id:u()}),Yi=h({type:f("response.content_part.added"),event_id:u(),item_id:u(),content_index:T(),output_index:T(),response_id:u(),part:h({audio:u().optional(),text:u().optional(),transcript:u().optional(),type:J(["text","audio"]).optional()})}),Xi=h({type:f("response.content_part.done"),event_id:u(),item_id:u(),content_index:T(),output_index:T(),response_id:u(),part:h({audio:u().optional(),text:u().optional(),transcript:u().optional(),type:J(["text","audio"]).optional()})}),Qi=h({type:f("response.created"),event_id:u(),response:Ea}),eu=h({type:f("response.done"),event_id:u(),response:Ea}),tu=h({type:f("response.function_call_arguments.delta"),event_id:u(),item_id:u(),call_id:u(),delta:u(),output_index:T(),response_id:u()}),nu=h({type:f("response.function_call_arguments.done"),event_id:u(),item_id:u(),call_id:u(),arguments:u(),output_index:T(),response_id:u()}),ru=h({type:f("response.output_item.added"),event_id:u(),item:Vt,output_index:T(),response_id:u()}),au=h({type:f("response.output_item.done"),event_id:u(),item:Vt,output_index:T(),response_id:u()}),su=h({type:f("response.text.delta"),event_id:u(),item_id:u(),content_index:T(),delta:u(),output_index:T(),response_id:u()}),ou=h({type:f("response.text.done"),event_id:u(),item_id:u(),content_index:T(),text:u(),output_index:T(),response_id:u()}),iu=h({type:f("session.created"),event_id:u(),session:$()}),uu=h({type:f("session.updated"),event_id:u(),session:$()}),cu=h({type:f("response.cancel"),event_id:u().optional(),response_id:u().optional()}),lu=h({type:f("response.create"),event_id:u().optional(),response:$().optional()}),du=h({type:f("session.update"),event_id:u().optional(),session:$()}),pu=h({type:f("transcription_session.update"),event_id:u().optional(),session:$()}),fu=h({type:f("transcription_session.updated"),event_id:u(),session:$()});h({type:u(),event_id:u().optional().nullable()}).passthrough();re("type",[Ti,bi,ki,Ii,Ai,Di,Oi,Ei,ji,Pi,Zi,Fi,Ji,Gi,Bi,Vi,zi,Hi,qi,Wi,Ki,Yi,Xi,Qi,eu,tu,nu,ru,au,su,ou,iu,uu,fu]);re("type",[Ci,Ri,Ni,$i,Mi,Li,Ui,cu,lu,du,pu]);Ys(new vi);xi();export{pt as A,_i as O,$o as R};
